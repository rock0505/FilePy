<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FilePy - æ™ºèƒ½æ–‡ä»¶ç®¡ç†</title>
    <style>
        /* ============================================
           CSS å˜é‡ - Material Design 3 é…è‰²æ–¹æ¡ˆ
           ============================================ */
        :root {
            /* ä¸»è‰²è°ƒ - è“è‰²ç³» */
            --md-primary: #1976D2;
            --md-primary-light: #42A5F5;
            --md-primary-dark: #1565C0;
            --md-on-primary: #FFFFFF;
            --md-primary-container: #D3E3FD;
            --md-on-primary-container: #041E49;

            /* è¡¨é¢è‰² - æµ…ç°èƒŒæ™¯ */
            --md-surface: #FFFBFE;
            --md-surface-variant: #F5F5F5;
            --md-surface-container: #F3F4F6;
            --md-on-surface: #1C1B1F;
            --md-on-surface-variant: #757575;

            /* è½®å»“è‰² */
            --md-outline: #79747E;
            --md-outline-variant: #CAC4D0;

            /* é”™è¯¯è‰² */
            --md-error: #B3261E;
            --md-on-error: #FFFFFF;
            --md-error-container: #F9DEDC;
            --md-on-error-container: #410E0B;

            /* æˆåŠŸè‰² */
            --md-success: #2E7D32;
            --md-success-container: #C8E6C9;
            --md-on-success-container: #0D3A10;

            /* è­¦å‘Šè‰² */
            --md-warning: #F57C00;
            --md-warning-container: #FFE0B2;
            --md-on-warning-container: #3E2723;

            /* é˜´å½± */
            --md-shadow-1: 0 1px 2px 0 rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
            --md-shadow-2: 0 1px 2px 0 rgba(0,0,0,0.3), 0 2px 6px 2px rgba(0,0,0,0.15);
            --md-shadow-3: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px 0 rgba(0,0,0,0.3);
            --md-shadow-4: 0 6px 10px 4px rgba(0,0,0,0.15), 0 2px 3px 0 rgba(0,0,0,0.15);

            /* åœ†è§’ */
            --md-radius-sm: 4px;
            --md-radius-md: 8px;
            --md-radius-lg: 12px;
            --md-radius-xl: 16px;
            --md-radius-full: 9999px;

            /* è¿‡æ¸¡ */
            --md-duration-short: 150ms;
            --md-duration-medium: 250ms;
            --md-easing-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* æ·±è‰²ä¸»é¢˜ */
        [data-theme="dark"] {
            --md-primary: #A8C7FA;
            --md-primary-light: #D3E3FD;
            --md-primary-dark: #4285F4;
            --md-on-primary: #041E49;
            --md-primary-container: #041E49;
            --md-on-primary-container: #D3E3FD;

            --md-surface: #1C1B1F;
            --md-surface-variant: #2B2930;
            --md-surface-container: #211F26;
            --md-on-surface: #E6E1E5;
            --md-on-surface-variant: #938F99;

            --md-outline: #938F99;
            --md-outline-variant: #49454F;

            --md-error: #F2B8B5;
            --md-on-error: #601410;
            --md-error-container: #8C1D18;
            --md-on-error-container: #F9DEDC';

            --md-success: #81C784;
            --md-success-container: #1B5E20;
            --md-on-success-container: #C8E6C9;

            --md-warning: #FFB74D;
            --md-warning-container: #E65100;
            --md-on-warning-container: #FFE0B2;

            --md-shadow-1: 0 1px 2px 0 rgba(0,0,0,0.5), 0 1px 3px 1px rgba(0,0,0,0.3);
            --md-shadow-2: 0 1px 2px 0 rgba(0,0,0,0.5), 0 2px 6px 2px rgba(0,0,0,0.3);
            --md-shadow-3: 0 4px 8px 3px rgba(0,0,0,0.3), 0 1px 3px 0 rgba(0,0,0,0.5);
            --md-shadow-4: 0 6px 10px 4px rgba(0,0,0,0.3), 0 2px 3px 0 rgba(0,0,0,0.5);
        }

        /* ============================================
           åŸºç¡€æ ·å¼é‡ç½®
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei UI', sans-serif;
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
            line-height: 1.5;
            overflow: hidden;
        }

        /* å›¾æ ‡æ ·å¼ */
        .icon {
            display: inline-block;
            font-style: normal;
            text-align: center;
            line-height: 1;
        }

        /* ============================================
           ç™»å½•ç•Œé¢
           ============================================ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--md-primary) 0%, var(--md-primary-dark) 100%);
            padding: 20px;
        }

        .login-card {
            background: var(--md-surface);
            border-radius: var(--md-radius-xl);
            padding: 40px;
            box-shadow: var(--md-shadow-4);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header .logo-icon {
            font-size: 48px;
            color: var(--md-primary);
            margin-bottom: 16px;
        }

        .login-header h4 {
            color: var(--md-on-surface);
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .login-header p {
            color: var(--md-on-surface-variant);
            font-size: 14px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--md-radius-md);
            font-size: 16px;
            background: var(--md-surface);
            color: var(--md-on-surface);
            transition: all var(--md-duration-short) var(--md-easing-standard);
            margin-bottom: 16px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px var(--md-primary-container);
        }

        .login-input::placeholder {
            color: var(--md-on-surface-variant);
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            border-radius: var(--md-radius-full);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--md-duration-medium) var(--md-easing-standard);
        }

        .login-btn:hover {
            background: var(--md-primary-dark);
            box-shadow: var(--md-shadow-2);
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-message {
            margin-top: 16px;
            padding: 12px;
            border-radius: var(--md-radius-md);
            font-size: 14px;
            text-align: center;
            background: var(--md-error-container);
            color: var(--md-on-error-container);
            display: none;
        }

        .login-message.show {
            display: block;
        }

        /* ============================================
           ä¸»ç•Œé¢å¸ƒå±€
           ============================================ */
        .main-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ============================================
           Header (å›ºå®šé¡¶éƒ¨å¯¼èˆªæ )
           ============================================ */
        .md-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: var(--md-surface);
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
            box-shadow: var(--md-shadow-1);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 200px;
        }

        .header-brand .icon {
            font-size: 24px;
            color: var(--md-primary);
        }

        .header-brand span:last-child {
            font-size: 20px;
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .header-search {
            flex: 1;
            max-width: 500px;
            margin: 0 16px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--md-surface-variant);
            border-radius: var(--md-radius-full);
            padding: 8px 16px;
            border: 1px solid transparent;
            transition: all var(--md-duration-short) var(--md-easing-standard);
        }

        .search-box:focus-within {
            background: var(--md-surface);
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px var(--md-primary-container);
        }

        .search-box .icon {
            color: var(--md-on-surface-variant);
            font-size: 18px;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 4px 8px;
            font-size: 16px;
            color: var(--md-on-surface);
        }

        .search-box input:focus {
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--md-on-surface-variant);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--md-duration-short) var(--md-easing-standard);
            font-size: 18px;
        }

        .icon-btn:hover {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
        }

        .icon-btn.active {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px 6px 6px;
            border-radius: var(--md-radius-full);
            cursor: pointer;
            transition: all var(--md-duration-short) var(--md-easing-standard);
        }

        .user-menu:hover {
            background: var(--md-surface-variant);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--md-primary);
            color: var(--md-on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .user-name {
            font-size: 14px;
            color: var(--md-on-surface);
        }

        /* ============================================
           Sidebar (ä¾§è¾¹æ )
           ============================================ */
        .md-sidebar {
            width: 200px;
            background: var(--md-surface);
            border-right: 1px solid var(--md-outline-variant);
            display: flex;
            flex-direction: column;
            padding-top: 64px;
            flex-shrink: 0;
        }

        .sidebar-nav {
            padding: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--md-radius-full);
            color: var(--md-on-surface-variant);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--md-duration-short) var(--md-easing-standard);
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
        }

        .nav-item.active {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
        }

        .nav-item .icon {
            font-size: 20px;
        }

        .nav-item span:last-child {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-divider {
            height: 1px;
            background: var(--md-outline-variant);
            margin: 16px 8px;
        }

        .sidebar-storage {
            padding: 0 16px;
        }

        .storage-info {
            margin-bottom: 12px;
        }

        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .storage-label {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .storage-value {
            font-size: 12px;
            color: var(--md-on-surface);
            font-weight: 500;
        }

        .storage-bar {
            height: 4px;
            background: var(--md-surface-variant);
            border-radius: 2px;
            overflow: hidden;
        }

        .storage-bar-fill {
            height: 100%;
            background: var(--md-primary);
            border-radius: 2px;
            transition: width var(--md-duration-medium) var(--md-easing-standard);
        }

        /* ============================================
           Main Content (ä¸»å†…å®¹åŒº)
           ============================================ */
        .md-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 64px;
            overflow: hidden;
            background: var(--md-surface-variant);
        }

        .content-toolbar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--md-surface);
            border-bottom: 1px solid var(--md-outline-variant);
            gap: 12px;
            flex-wrap: wrap;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--md-on-surface-variant);
            font-size: 14px;
            overflow: hidden;
        }

        .breadcrumb .icon {
            font-size: 16px;
        }

        .breadcrumb a {
            color: var(--md-on-surface-variant);
            text-decoration: none;
            white-space: nowrap;
            transition: color var(--md-duration-short) var(--md-easing-standard);
        }

        .breadcrumb a:hover {
            color: var(--md-primary);
        }

        .breadcrumb .separator {
            color: var(--md-outline-variant);
        }

        .breadcrumb .current {
            color: var(--md-on-surface);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toolbar-spacer {
            flex: 1;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: var(--md-radius-full);
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--md-duration-short) var(--md-easing-standard);
        }

        .btn-primary {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        .btn-primary:hover {
            background: var(--md-primary-dark);
            box-shadow: var(--md-shadow-1);
        }

        .btn-tonal {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
        }

        .btn-tonal:hover {
            background: var(--md-surface-container);
        }

        .btn-danger {
            background: var(--md-error-container);
            color: var(--md-on-error-container);
        }

        .btn-danger:hover {
            background: var(--md-error);
            color: var(--md-on-error);
        }

        .btn .icon {
            font-size: 18px;
        }

        /* ============================================
           File Views (æ–‡ä»¶è§†å›¾)
           ============================================ */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* åˆ—è¡¨è§†å›¾ */
        .file-list-view {
            background: var(--md-surface);
            border-radius: var(--md-radius-lg);
            overflow: hidden;
            box-shadow: var(--md-shadow-1);
        }

        .list-header {
            display: grid;
            grid-template-columns: 48px 1fr 120px 160px 120px;
            padding: 12px 16px;
            background: var(--md-surface-variant);
            border-bottom: 1px solid var(--md-outline-variant);
            font-size: 12px;
            font-weight: 500;
            color: var(--md-on-surface-variant);
        }

        .list-header span {
            display: flex;
            align-items: center;
        }

        .list-body {
            max-height: calc(100vh - 220px);
            overflow-y: auto;
        }

        .list-item {
            display: grid;
            grid-template-columns: 48px 1fr 120px 160px 120px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--md-outline-variant);
            align-items: center;
            cursor: pointer;
            transition: background var(--md-duration-short) var(--md-easing-standard);
        }

        .list-item:hover {
            background: var(--md-surface-variant);
        }

        .list-item.selected {
            background: var(--md-primary-container);
        }

        .list-item .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .list-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--md-primary);
        }

        .list-item .file-icon {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-item .file-icon .icon {
            font-size: 22px;
        }

        .list-item .file-name {
            font-size: 14px;
            color: var(--md-on-surface);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .list-item .file-size,
        .list-item .file-date {
            font-size: 13px;
            color: var(--md-on-surface-variant);
        }

        .list-item .file-actions {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
        }

        /* ç½‘æ ¼è§†å›¾ */
        .file-grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
        }

        .grid-item {
            background: var(--md-surface);
            border-radius: var(--md-radius-md);
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all var(--md-duration-short) var(--md-easing-standard);
            box-shadow: var(--md-shadow-1);
            position: relative;
        }

        .grid-item:hover {
            box-shadow: var(--md-shadow-2);
            transform: translateY(-2px);
        }

        .grid-item.selected {
            background: var(--md-primary-container);
        }

        .grid-item .checkbox-wrapper {
            position: absolute;
            top: 8px;
            left: 8px;
        }

        .grid-item .checkbox-wrapper input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--md-primary);
        }

        .grid-item .item-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .grid-item .item-name {
            font-size: 13px;
            color: var(--md-on-surface);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }

        .grid-item .item-meta {
            font-size: 11px;
            color: var(--md-on-surface-variant);
            margin-top: 4px;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--md-on-surface-variant);
        }

        .empty-state .icon {
            font-size: 64px;
            opacity: 0.5;
            margin-bottom: 16px;
        }

        .empty-state p {
            font-size: 16px;
        }

        /* ============================================
           ä¸Šä¸‹æ–‡èœå•
           ============================================ */
        .context-menu {
            position: fixed;
            background: var(--md-surface);
            border-radius: var(--md-radius-md);
            box-shadow: var(--md-shadow-3);
            padding: 8px;
            min-width: 160px;
            z-index: 1000;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: var(--md-radius-sm);
            color: var(--md-on-surface);
            font-size: 14px;
            cursor: pointer;
            transition: background var(--md-duration-short) var(--md-easing-standard);
        }

        .context-menu-item:hover {
            background: var(--md-surface-variant);
        }

        .context-menu-item .icon {
            font-size: 18px;
            color: var(--md-on-surface-variant);
        }

        .context-menu-item.danger {
            color: var(--md-error);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--md-outline-variant);
            margin: 4px 0;
        }

        /* ============================================
           å¯¹è¯æ¡†
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--md-duration-medium) var(--md-easing-standard);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--md-surface);
            border-radius: var(--md-radius-xl);
            box-shadow: var(--md-shadow-4);
            min-width: 320px;
            max-width: 480px;
            transform: scale(0.9);
            transition: transform var(--md-duration-medium) var(--md-easing-standard);
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px 16px;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .modal-body {
            padding: 0 24px 20px;
        }

        .modal-body .input-group {
            margin-bottom: 16px;
        }

        .modal-body label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--md-on-surface-variant);
            margin-bottom: 8px;
        }

        .modal-body input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--md-radius-md);
            font-size: 16px;
            background: var(--md-surface);
            color: var(--md-on-surface);
        }

        .modal-body input:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px var(--md-primary-container);
        }

        .modal-footer {
            padding: 12px 24px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* ============================================
           é€šçŸ¥ Toast
           ============================================ */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--md-surface);
            border-radius: var(--md-radius-md);
            box-shadow: var(--md-shadow-3);
            min-width: 280px;
            max-width: 400px;
            animation: toastIn var(--md-duration-medium) var(--md-easing-standard);
        }

        @keyframes toastIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            background: var(--md-success-container);
            color: var(--md-on-success-container);
        }

        .toast.error {
            background: var(--md-error-container);
            color: var(--md-on-error-container);
        }

        .toast.info {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
        }

        .toast .icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            opacity: 0.7;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* ============================================
           æ–‡ä»¶ç±»å‹å›¾æ ‡é¢œè‰²
           ============================================ */
        .icon-folder { color: #FFB300; }
        .icon-image { color: #4CAF50; }
        .icon-video { color: #E91E63; }
        .icon-audio { color: #9C27B0; }
        .icon-document { color: #2196F3; }
        .icon-archive { color: #FF9800; }
        .icon-code { color: #00BCD4; }
        .icon-default { color: var(--md-on-surface-variant); }

        [data-theme="dark"] .icon-folder { color: #FFCA28; }
        [data-theme="dark"] .icon-image { color: #66BB6A; }
        [data-theme="dark"] .icon-video { color: #F06292; }
        [data-theme="dark"] .icon-audio { color: #BA68C8; }
        [data-theme="dark"] .icon-document { color: #42A5F5; }
        [data-theme="dark"] .icon-archive { color: #FFB74D; }
        [data-theme="dark"] .icon-code { color: #26C6DA; }

        /* ============================================
           ä¸Šä¼ åŒºåŸŸ
           ============================================ */
        .upload-zone {
            border: 2px dashed var(--md-outline-variant);
            border-radius: var(--md-radius-lg);
            padding: 32px;
            text-align: center;
            background: var(--md-surface-variant);
            transition: all var(--md-duration-short) var(--md-easing-standard);
            margin-bottom: 16px;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: var(--md-primary);
            background: var(--md-primary-container);
        }

        .upload-zone .icon {
            font-size: 48px;
            color: var(--md-on-surface-variant);
            margin-bottom: 12px;
        }

        .upload-zone p {
            color: var(--md-on-surface-variant);
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* ============================================
           å“åº”å¼è®¾è®¡
           ============================================ */
        @media (max-width: 1024px) {
            .list-header .file-date,
            .list-item .file-date {
                display: none;
            }

            .list-header,
            .list-item {
                grid-template-columns: 48px 1fr 120px 100px;
            }
        }

        @media (max-width: 768px) {
            .md-sidebar {
                position: fixed;
                left: -200px;
                top: 0;
                bottom: 0;
                z-index: 150;
                transition: left var(--md-duration-medium) var(--md-easing-standard);
            }

            .md-sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 140;
                display: none;
            }

            .sidebar-overlay.show {
                display: block;
            }

            .menu-toggle {
                display: flex !important;
            }

            .header-search {
                display: none;
            }

            .list-header .file-size,
            .list-item .file-size {
                display: none;
            }

            .list-header,
            .list-item {
                grid-template-columns: 48px 1fr 100px;
            }

            .file-grid-view {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .breadcrumb {
                font-size: 12px;
            }

            .btn span:not(.icon) {
                display: none;
            }
        }

        @media (min-width: 769px) {
            .menu-toggle {
                display: none !important;
            }
        }

        /* ============================================
           æ±‰å ¡èœå•åŠ¨ç”»
           ============================================ */
        .hamburger {
            width: 24px;
            height: 2px;
            background: var(--md-on-surface);
            position: relative;
            transition: all var(--md-duration-medium) var(--md-easing-standard);
        }

        .hamburger::before,
        .hamburger::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 2px;
            background: var(--md-on-surface);
            transition: all var(--md-duration-medium) var(--md-easing-standard);
        }

        .hamburger::before {
            top: -8px;
        }

        .hamburger::after {
            bottom: -8px;
        }

        .menu-toggle.active .hamburger {
            background: transparent;
        }

        .menu-toggle.active .hamburger::before {
            transform: rotate(45deg);
            top: 0;
        }

        .menu-toggle.active .hamburger::after {
            transform: rotate(-45deg);
            bottom: 0;
        }

        /* ============================================
           åŠ è½½åŠ¨ç”»
           ============================================ */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--md-outline-variant);
            border-top-color: var(--md-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           å·¥å…·æç¤º
           ============================================ */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: var(--md-on-surface);
            color: var(--md-surface);
            font-size: 12px;
            border-radius: var(--md-radius-sm);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all var(--md-duration-short) var(--md-easing-standard);
            margin-bottom: 8px;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <span class="icon logo-icon">ğŸ“</span>
                <h4>FilePy æ–‡ä»¶æœåŠ¡å™¨</h4>
                <p>å®‰å…¨å¯é çš„æ–‡ä»¶ç®¡ç†è§£å†³æ–¹æ¡ˆ</p>
            </div>
            <div class="login-form">
                <input type="text" class="login-input" id="username" placeholder="ç”¨æˆ·å" required>
                <input type="password" class="login-input" id="password" placeholder="å¯†ç " required>
                <button class="login-btn" onclick="login()">
                    <span class="icon">ğŸ”</span>
                    ç™»å½•
                </button>
                <div class="login-message" id="loginMessage"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="mainContainer" class="main-container" style="display: none;">
        <!-- Header -->
        <header class="md-header">
            <div class="header-brand">
                <button class="icon-btn menu-toggle" onclick="toggleSidebar()">
                    <div class="hamburger"></div>
                </button>
                <span class="icon">ğŸ“</span>
                <span>FilePy</span>
            </div>
            <div class="header-search">
                <div class="search-box">
                    <span class="icon">ğŸ”</span>
                    <input type="text" id="headerSearchInput" placeholder="æœç´¢æ–‡ä»¶..." onkeypress="if(event.key==='Enter'){searchFiles();}">
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleTheme()" data-tooltip="åˆ‡æ¢ä¸»é¢˜">
                    <span class="icon" id="themeIcon">ğŸŒ™</span>
                </button>
                <button class="icon-btn" onclick="toggleView()" data-tooltip="åˆ‡æ¢è§†å›¾">
                    <span class="icon" id="viewIcon">âŠ</span>
                </button>
                <button class="icon-btn" onclick="refreshFiles()" data-tooltip="åˆ·æ–°">
                    <span class="icon">ğŸ”„</span>
                </button>
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span class="user-name" id="userName">ç®¡ç†å‘˜</span>
                    <span class="icon">â–¼</span>
                </div>
            </div>
        </header>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="md-sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <a class="nav-item active" onclick="loadFiles()">
                    <span class="icon">ğŸ“</span>
                    <span>å…¨éƒ¨æ–‡ä»¶</span>
                </a>
                <a class="nav-item" onclick="showRecentFiles()">
                    <span class="icon">ğŸ•</span>
                    <span>æœ€è¿‘</span>
                </a>
                <a class="nav-item" onclick="showStarredFiles()">
                    <span class="icon">â­</span>
                    <span>æ”¶è—</span>
                </a>
            </nav>
            <div class="sidebar-divider"></div>
            <div class="sidebar-storage">
                <div class="storage-info">
                    <div class="storage-header">
                        <span class="storage-label">å­˜å‚¨ç©ºé—´</span>
                        <span class="storage-value" id="storageValue">2.4 GB / 10 GB</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-bar-fill" id="storageBarFill" style="width: 24%;"></div>
                    </div>
                </div>
            </div>
            <div class="sidebar-divider"></div>
            <nav class="sidebar-nav">
                <a class="nav-item" onclick="showSettings()">
                    <span class="icon">âš™ï¸</span>
                    <span>è®¾ç½®</span>
                </a>
                <a class="nav-item" onclick="logout()">
                    <span class="icon">ğŸšª</span>
                    <span>é€€å‡ºç™»å½•</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="md-main">
            <!-- Toolbar -->
            <div class="content-toolbar">
                <div class="breadcrumb" id="breadcrumb">
                    <a href="#" onclick="navigateTo('/')">
                        <span class="icon">ğŸ </span>
                    </a>
                    <span class="separator">/</span>
                    <span class="current" id="currentPathName">å…¨éƒ¨æ–‡ä»¶</span>
                </div>
                <div class="toolbar-spacer"></div>
                <label class="btn btn-tonal" style="padding: 8px 12px;">
                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" style="margin: 0;">
                    å…¨é€‰
                </label>
                <button class="btn btn-primary" onclick="createNewFolder()">
                    <span class="icon">ğŸ“+</span>
                    <span>æ–°å»ºæ–‡ä»¶å¤¹</span>
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <span class="icon">â¬†ï¸</span>
                    <span>ä¸Šä¼ </span>
                </button>
                <button class="btn btn-danger" onclick="batchDelete()" id="batchDeleteBtn" style="display: none;">
                    <span class="icon">ğŸ—‘ï¸</span>
                </button>
                <button class="btn btn-tonal" onclick="batchDownload()" id="batchDownloadBtn" style="display: none;">
                    <span class="icon">â¬‡ï¸</span>
                </button>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <span class="icon">â˜ï¸</span>
                    <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                    <button class="btn btn-tonal" onclick="document.getElementById('fileInput').click()">
                        <span class="icon">ğŸ“‚</span>
                        é€‰æ‹©æ–‡ä»¶
                    </button>
                    <div id="selectedFileInfo" style="margin-top: 12px; color: var(--md-success); font-size: 13px;"></div>
                </div>

                <!-- File Container -->
                <div id="fileContainer">
                    <div class="file-list-view" id="listView">
                        <div class="list-header">
                            <span></span>
                            <span>åç§°</span>
                            <span>å¤§å°</span>
                            <span>ä¿®æ”¹æ—¶é—´</span>
                            <span>æ“ä½œ</span>
                        </div>
                        <div class="list-body" id="fileList">
                            <div class="empty-state">
                                <span class="icon">ğŸ“­</span>
                                <p>åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                    <div class="file-grid-view" id="gridView" style="display: none;"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- ä¸Šä¸‹æ–‡èœå• -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextMenuAction('open')">
            <span class="icon">ğŸ“‚</span>
            æ‰“å¼€
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('download')">
            <span class="icon">â¬‡ï¸</span>
            ä¸‹è½½
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('rename')">
            <span class="icon">âœï¸</span>
            é‡å‘½å
        </div>
        <div class="context-menu-item danger" onclick="contextMenuAction('delete')">
            <span class="icon">ğŸ—‘ï¸</span>
            åˆ é™¤
        </div>
    </div>

    <!-- å¯¹è¯æ¡†å®¹å™¨ -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 id="modalTitle">æ ‡é¢˜</h3>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-tonal" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="modalConfirm">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFilesSelect(this.files)">

    <script>
        // ============================================
        // å…¨å±€çŠ¶æ€
        // ============================================
        let authToken = null;
        let currentUser = null;
        let allFiles = [];
        let currentPath = "/";
        let currentView = "list"; // list | grid
        let currentTheme = "light";
        let contextMenuItem = null;

        // ============================================
        // æ–‡ä»¶ç±»å‹å›¾æ ‡æ˜ å°„
        // ============================================
        const FILE_TYPE_ICONS = {
            folder: { icon: 'ğŸ“', class: 'icon-folder' },
            // å›¾ç‰‡
            image: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            img: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            jpg: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            jpeg: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            png: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            gif: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            webp: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            bmp: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            svg: { icon: 'ğŸ–¼ï¸', class: 'icon-image' },
            // è§†é¢‘
            video: { icon: 'ğŸ¬', class: 'icon-video' },
            mp4: { icon: 'ğŸ¬', class: 'icon-video' },
            avi: { icon: 'ğŸ¬', class: 'icon-video' },
            mkv: { icon: 'ğŸ¬', class: 'icon-video' },
            mov: { icon: 'ğŸ¬', class: 'icon-video' },
            webm: { icon: 'ğŸ¬', class: 'icon-video' },
            // éŸ³é¢‘
            audio: { icon: 'ğŸµ', class: 'icon-audio' },
            mp3: { icon: 'ğŸµ', class: 'icon-audio' },
            wav: { icon: 'ğŸµ', class: 'icon-audio' },
            flac: { icon: 'ğŸµ', class: 'icon-audio' },
            ogg: { icon: 'ğŸµ', class: 'icon-audio' },
            // æ–‡æ¡£
            document: { icon: 'ğŸ“„', class: 'icon-document' },
            pdf: { icon: 'ğŸ“•', class: 'icon-document' },
            doc: { icon: 'ğŸ“„', class: 'icon-document' },
            docx: { icon: 'ğŸ“„', class: 'icon-document' },
            txt: { icon: 'ğŸ“', class: 'icon-document' },
            xls: { icon: 'ğŸ“Š', class: 'icon-document' },
            xlsx: { icon: 'ğŸ“Š', class: 'icon-document' },
            ppt: { icon: 'ğŸ“Š', class: 'icon-document' },
            pptx: { icon: 'ğŸ“Š', class: 'icon-document' },
            // å‹ç¼©åŒ…
            archive: { icon: 'ğŸ—œï¸', class: 'icon-archive' },
            zip: { icon: 'ğŸ—œï¸', class: 'icon-archive' },
            rar: { icon: 'ğŸ—œï¸', class: 'icon-archive' },
            '7z': { icon: 'ğŸ—œï¸', class: 'icon-archive' },
            tar: { icon: 'ğŸ—œï¸', class: 'icon-archive' },
            gz: { icon: 'ğŸ—œï¸', class: 'icon-archive' },
            // ä»£ç 
            code: { icon: 'ğŸ’»', class: 'icon-code' },
            js: { icon: 'ğŸ“œ', class: 'icon-code' },
            py: { icon: 'ğŸ', class: 'icon-code' },
            html: { icon: 'ğŸŒ', class: 'icon-code' },
            css: { icon: 'ğŸ¨', class: 'icon-code' },
            json: { icon: 'ğŸ“‹', class: 'icon-code' },
            xml: { icon: 'ğŸ“‹', class: 'icon-code' },
            md: { icon: 'ğŸ“‹', class: 'icon-code' },
            // å…¶ä»–
            default: { icon: 'ğŸ“„', class: 'icon-default' }
        };

        function getFileTypeIcon(filename, isDir) {
            if (isDir) return FILE_TYPE_ICONS.folder;

            const ext = filename.split('.').pop().toLowerCase();
            return FILE_TYPE_ICONS[ext] || FILE_TYPE_ICONS.default;
        }

        // ============================================
        // åˆå§‹åŒ–
        // ============================================
        window.onload = function() {
            // æ£€æŸ¥ä¿å­˜çš„ä¸»é¢˜
            const savedTheme = localStorage.getItem('filepy_theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', currentTheme);
                updateThemeIcon();
            }

            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            const storedToken = localStorage.getItem('filepy_token');
            const storedUser = localStorage.getItem('filepy_user');
            if (storedToken) {
                if (isTokenExpired(storedToken)) {
                    localStorage.removeItem('filepy_token');
                    localStorage.removeItem('filepy_user');
                    return;
                }
                authToken = storedToken;
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    updateUserDisplay();
                }
                showMainInterface();
                loadFiles();
            }

            // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
            setupDragDrop();

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­ä¸Šä¸‹æ–‡èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });
        };

        function isTokenExpired(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp;
                const now = Math.floor(Date.now() / 1000);
                return exp - now < 300;
            } catch (e) {
                return true;
            }
        }

        // ============================================
        // è®¤è¯ç›¸å…³
        // ============================================
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageElement = document.getElementById('loginMessage');

            if (!username || !password) {
                showLoginMessage('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
                return;
            }

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    currentUser = {username: username};
                    localStorage.setItem('filepy_token', authToken);
                    localStorage.setItem('filepy_user', JSON.stringify(currentUser));
                    hideLoginMessage();
                    updateUserDisplay();
                    showMainInterface();
                    loadFiles();
                } else {
                    const error = await response.json();
                    showLoginMessage('ç™»å½•å¤±è´¥: ' + error.detail);
                }
            } catch (error) {
                showLoginMessage('ç™»å½•è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('filepy_token');
            localStorage.removeItem('filepy_user');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            hideLoginMessage();
        }

        function showMainInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
        }

        function showLoginMessage(message) {
            const messageElement = document.getElementById('loginMessage');
            messageElement.textContent = message;
            messageElement.classList.add('show');
        }

        function hideLoginMessage() {
            document.getElementById('loginMessage').classList.remove('show');
        }

        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
                document.getElementById('userName').textContent = currentUser.username;
            }
        }

        // ============================================
        // ä¸»é¢˜åˆ‡æ¢
        // ============================================
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('filepy_theme', currentTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const icon = document.getElementById('themeIcon');
            icon.textContent = currentTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        // ============================================
        // è§†å›¾åˆ‡æ¢
        // ============================================
        function toggleView() {
            currentView = currentView === 'list' ? 'grid' : 'list';
            document.getElementById('listView').style.display = currentView === 'list' ? 'block' : 'none';
            document.getElementById('gridView').style.display = currentView === 'grid' ? 'grid' : 'none';
            document.getElementById('viewIcon').textContent = currentView === 'list' ? 'âŠ' : 'â˜°';
            displayFiles(allFiles);
        }

        // ============================================
        // ä¾§è¾¹æ åˆ‡æ¢
        // ============================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuToggle = document.querySelector('.menu-toggle');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            menuToggle.classList.toggle('active');
        }

        // ============================================
        // æ–‡ä»¶åŠ è½½ä¸æ˜¾ç¤º
        // ============================================
        async function loadFiles(path = null) {
            if (!authToken) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            const targetPath = path !== null ? path : currentPath;

            try {
                const response = await fetch(`/files?path=${encodeURIComponent(targetPath)}`, {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });

                if (response.ok) {
                    const files = await response.json();
                    allFiles = files;
                    currentPath = targetPath;
                    updateBreadcrumb();
                    displayFiles(files);
                } else {
                    showToast('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
            }
        }

        function displayFiles(files) {
            const listElement = document.getElementById('fileList');
            const gridElement = document.getElementById('gridView');

            if (!files || files.length === 0) {
                const emptyHtml = `
                    <div class="empty-state">
                        <span class="icon">ğŸ“­</span>
                        <p>æ²¡æœ‰æ–‡ä»¶</p>
                    </div>
                `;
                listElement.innerHTML = emptyHtml;
                gridElement.innerHTML = emptyHtml;
                return;
            }

            // åˆ—è¡¨è§†å›¾
            listElement.innerHTML = files.map(file => {
                const icon = getFileTypeIcon(file.name, file.is_dir);
                const size = file.is_dir ? '' : formatFileSize(file.size || 0);
                const date = file.modified ? formatDate(file.modified) : 'æœªçŸ¥';

                return `
                    <div class="list-item" data-is-dir="${file.is_dir}" data-path="${file.path}"
                         ondblclick="${file.is_dir ? `navigateTo('${file.path}')` : `downloadFile('${file.path}')`}"
                         oncontextmenu="showContextMenu(event, '${file.path}', ${file.is_dir})">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="file-checkbox"
                                   data-path="${file.path}"
                                   data-name="${file.name}"
                                   data-is-dir="${file.is_dir}"
                                   onchange="updateBatchButtons()">
                        </div>
                        <div class="file-icon">
                            <span class="icon ${icon.class}">${icon.icon}</span>
                            <span class="file-name">${file.name}</span>
                        </div>
                        <span class="file-size">${size}</span>
                        <span class="file-date">${date}</span>
                        <div class="file-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); renameFile('${file.path}', '${file.name.replace(/'/g, "\\'")}')" data-tooltip="é‡å‘½å">
                                <span class="icon">âœï¸</span>
                            </button>
                            <button class="icon-btn" onclick="event.stopPropagation(); deleteFile('${file.path}')" data-tooltip="åˆ é™¤">
                                <span class="icon">ğŸ—‘ï¸</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // ç½‘æ ¼è§†å›¾
            gridElement.innerHTML = files.map(file => {
                const icon = getFileTypeIcon(file.name, file.is_dir);
                const size = file.is_dir ? '' : formatFileSize(file.size || 0);

                return `
                    <div class="grid-item" data-is-dir="${file.is_dir}" data-path="${file.path}"
                         ondblclick="${file.is_dir ? `navigateTo('${file.path}')` : `downloadFile('${file.path}')`}"
                         oncontextmenu="showContextMenu(event, '${file.path}', ${file.is_dir})">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="file-checkbox"
                                   data-path="${file.path}"
                                   data-name="${file.name}"
                                   data-is-dir="${file.is_dir}"
                                   onchange="updateBatchButtons()">
                        </div>
                        <span class="icon item-icon ${icon.class}">${icon.icon}</span>
                        <span class="item-name">${file.name}</span>
                        <span class="item-meta">${size}</span>
                    </div>
                `;
            }).join('');
        }

        function updateBreadcrumb() {
            const currentPathName = document.getElementById('currentPathName');
            if (currentPath === '/') {
                currentPathName.textContent = 'å…¨éƒ¨æ–‡ä»¶';
            } else {
                const parts = currentPath.split('/').filter(p => p);
                currentPathName.textContent = parts[parts.length - 1] || 'å…¨éƒ¨æ–‡ä»¶';
            }
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        function navigateTo(path) {
            loadFiles(path);
        }

        function refreshFiles() {
            loadFiles();
        }

        // ============================================
        // æ–‡ä»¶æ“ä½œ
        // ============================================
        async function createNewFolder() {
            showModal('æ–°å»ºæ–‡ä»¶å¤¹', `
                <div class="input-group">
                    <label>æ–‡ä»¶å¤¹åç§°</label>
                    <input type="text" id="folderName" placeholder="è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°" value="æ–°å»ºæ–‡ä»¶å¤¹">
                </div>
            `, async () => {
                const folderName = document.getElementById('folderName').value;
                if (!folderName || !folderName.trim()) {
                    showToast('æ–‡ä»¶å¤¹åç§°ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }

                try {
                    const response = await fetch('/files/mkdir', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            path: currentPath,
                            name: folderName.trim()
                        })
                    });

                    if (response.ok) {
                        showToast('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ', 'success');
                        closeModal();
                        loadFiles();
                    } else {
                        const error = await response.json();
                        showToast('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                }
            });
        }

        async function downloadFile(filePath) {
            if (!authToken) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const response = await fetch(`/files/download/${filePath}`, {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filePath.split('/').pop();
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    showToast('æ–‡ä»¶ä¸‹è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ–‡ä»¶ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function renameFile(oldPath, oldName) {
            showModal('é‡å‘½å', `
                <div class="input-group">
                    <label>æ–°åç§°</label>
                    <input type="text" id="newName" placeholder="è¯·è¾“å…¥æ–°åç§°" value="${oldName}">
                </div>
            `, async () => {
                const newName = document.getElementById('newName').value;
                if (!newName || !newName.trim() || newName === oldName) {
                    return;
                }

                try {
                    const response = await fetch('/files/rename', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            old_path: oldPath,
                            new_name: newName.trim()
                        })
                    });

                    if (response.ok) {
                        showToast('é‡å‘½åæˆåŠŸ', 'success');
                        closeModal();
                        loadFiles();
                    } else {
                        const error = await response.json();
                        showToast('é‡å‘½åå¤±è´¥: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('é‡å‘½åå¤±è´¥: ' + error.message, 'error');
                }
            });
        }

        async function deleteFile(filePath) {
            if (!authToken) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            showModal('ç¡®è®¤åˆ é™¤', `
                <p>ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            `, async () => {
                try {
                    const response = await fetch(`/files/${encodeURIComponent(filePath)}`, {
                        method: 'DELETE',
                        headers: {'Authorization': `Bearer ${authToken}`}
                    });

                    if (response.ok) {
                        showToast('æ–‡ä»¶åˆ é™¤æˆåŠŸ', 'success');
                        closeModal();
                        loadFiles();
                    } else {
                        const error = await response.json();
                        showToast('æ–‡ä»¶åˆ é™¤å¤±è´¥: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('æ–‡ä»¶åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            });
        }

        // ============================================
        // æ‰¹é‡æ“ä½œ
        // ============================================
        function getSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            return Array.from(checkboxes).map(cb => ({
                path: cb.dataset.path,
                name: cb.dataset.name,
                is_dir: cb.dataset.isDir === 'true'
            }));
        }

        function updateBatchButtons() {
            const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const batchDownloadBtn = document.getElementById('batchDownloadBtn');

            if (selectedCount > 0) {
                batchDeleteBtn.style.display = 'inline-flex';
                batchDownloadBtn.style.display = 'inline-flex';
            } else {
                batchDeleteBtn.style.display = 'none';
                batchDownloadBtn.style.display = 'none';
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateBatchButtons();
        }

        async function batchDelete() {
            const selectedFiles = getSelectedFiles();
            if (selectedFiles.length === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶', 'error');
                return;
            }

            showModal('ç¡®è®¤æ‰¹é‡åˆ é™¤', `
                <p>ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedFiles.length} ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            `, async () => {
                try {
                    const response = await fetch('/files/batch', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            paths: selectedFiles.map(f => f.path)
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showToast(result.message, 'success');
                        closeModal();
                        loadFiles();
                        document.getElementById('selectAll').checked = false;
                        updateBatchButtons();
                    } else {
                        const error = await response.json();
                        showToast('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('æ‰¹é‡åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            });
        }

        async function batchDownload() {
            const selectedFiles = getSelectedFiles();
            if (selectedFiles.length === 0) {
                showToast('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶', 'error');
                return;
            }

            const filesOnly = selectedFiles.filter(f => !f.is_dir);
            if (filesOnly.length === 0) {
                showToast('è¯·é€‰æ‹©æ–‡ä»¶è¿›è¡Œä¸‹è½½ï¼ˆä¸æ”¯æŒä¸‹è½½ç›®å½•ï¼‰', 'error');
                return;
            }

            for (const file of filesOnly) {
                await downloadFile(file.path);
            }
            showToast(`å·²å¼€å§‹ä¸‹è½½ ${filesOnly.length} ä¸ªæ–‡ä»¶`, 'info');
        }

        // ============================================
        // æœç´¢åŠŸèƒ½
        // ============================================
        async function searchFiles() {
            const searchTerm = document.getElementById('headerSearchInput').value.trim();
            if (!searchTerm) {
                loadFiles();
                return;
            }

            if (!authToken) {
                showToast('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            try {
                const response = await fetch('/files/search', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: currentPath,
                        name: searchTerm
                    })
                });

                if (response.ok) {
                    const results = await response.json();
                    allFiles = results;
                    displayFiles(results);
                } else {
                    showToast('æœç´¢å¤±è´¥: ' + (await response.json()).detail, 'error');
                }
            } catch (error) {
                showToast('æœç´¢å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ============================================
        // æ‹–æ‹½ä¸Šä¼ 
        // ============================================
        function setupDragDrop() {
            const uploadZone = document.getElementById('uploadZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, function() {
                    uploadZone.classList.add('drag-over');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, function() {
                    uploadZone.classList.remove('drag-over');
                });
            });

            uploadZone.addEventListener('drop', function(e) {
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
        }

        async function handleFilesSelect(files) {
            handleFiles(files);
        }

        async function handleFiles(files) {
            if (!files || files.length === 0) return;

            const fileInfo = document.getElementById('selectedFileInfo');
            fileInfo.textContent = `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶`;

            for (const file of files) {
                await uploadFile(file);
            }

            fileInfo.textContent = '';
            showToast(`ä¸Šä¼ å®Œæˆ ${files.length} ä¸ªæ–‡ä»¶`, 'success');
            loadFiles();
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('path', currentPath);

            try {
                const response = await fetch('/files/upload', {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${authToken}`},
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    showToast(`ä¸Šä¼  ${file.name} å¤±è´¥: ${error.detail}`, 'error');
                }
            } catch (error) {
                showToast(`ä¸Šä¼  ${file.name} å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ============================================
        // ä¸Šä¸‹æ–‡èœå•
        // ============================================
        function showContextMenu(event, path, isDir) {
            event.preventDefault();
            event.stopPropagation();

            contextMenuItem = { path, isDir };

            const menu = document.getElementById('contextMenu');
            menu.style.top = event.clientY + 'px';
            menu.style.left = event.clientX + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
        }

        function contextMenuAction(action) {
            if (!contextMenuItem) return;

            const { path, isDir } = contextMenuItem;
            const fileName = path.split('/').pop();

            switch (action) {
                case 'open':
                    if (isDir) {
                        navigateTo(path);
                    } else {
                        downloadFile(path);
                    }
                    break;
                case 'download':
                    if (!isDir) {
                        downloadFile(path);
                    } else {
                        showToast('ä¸æ”¯æŒä¸‹è½½ç›®å½•', 'error');
                    }
                    break;
                case 'rename':
                    renameFile(path, fileName);
                    break;
                case 'delete':
                    deleteFile(path);
                    break;
            }

            hideContextMenu();
        }

        // ============================================
        // å¯¹è¯æ¡†
        // ============================================
        function showModal(title, bodyHtml, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;
            document.getElementById('modalOverlay').classList.add('show');

            const confirmBtn = document.getElementById('modalConfirm');
            confirmBtn.onclick = onConfirm;
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
        }

        // ============================================
        // Toast é€šçŸ¥
        // ============================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const iconMap = {
                success: 'âœ“',
                error: 'âœ•',
                info: 'â„¹'
            };

            toast.innerHTML = `
                <span class="icon">${iconMap[type] || iconMap.info}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <span class="icon">âœ•</span>
                </button>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // ============================================
        // å¯¼èˆªå ä½å‡½æ•°
        // ============================================
        function showRecentFiles() {
            showToast('æœ€è¿‘æ–‡ä»¶åŠŸèƒ½å¼€å‘ä¸­', 'info');
        }

        function showStarredFiles() {
            showToast('æ”¶è—åŠŸèƒ½å¼€å‘ä¸­', 'info');
        }

        function showSettings() {
            showToast('è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­', 'info');
        }

        function toggleUserMenu() {
            showToast('ç”¨æˆ·èœå•å¼€å‘ä¸­', 'info');
        }

        // ============================================
        // é”®ç›˜äº‹ä»¶
        // ============================================
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // ESC å…³é—­å¯¹è¯æ¡†
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                hideContextMenu();
            }
        });
    </script>
</body>
</html>
