<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FilePy - 智能文件管理</title>
    <!-- Material Icons Outlined -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        /* ============================================
           CSS 变量 - Material Design 3 配色方案
           ============================================ */
        :root {
            /* 主色调 - 蓝色系 */
            --md-primary: #1976D2;
            --md-primary-light: #42A5F5;
            --md-primary-dark: #1565C0;
            --md-on-primary: #FFFFFF;
            --md-primary-container: #D3E3FD;
            --md-on-primary-container: #041E49;

            /* 表面色 - 浅灰背景 */
            --md-surface: #FFFBFE;
            --md-surface-variant: #F5F5F5;
            --md-surface-container: #F3F4F6;
            --md-on-surface: #1C1B1F;
            --md-on-surface-variant: #757575;

            /* 轮廓色 */
            --md-outline: #79747E;
            --md-outline-variant: #CAC4D0;

            /* 错误色 */
            --md-error: #B3261E;
            --md-on-error: #FFFFFF;
            --md-error-container: #F9DEDC;
            --md-on-error-container: #410E0B;

            /* 成功色 */
            --md-success: #2E7D32;
            --md-success-container: #C8E6C9;
            --md-on-success-container: #0D3A10;

            /* 警告色 */
            --md-warning: #F57C00;
            --md-warning-container: #FFE0B2;
            --md-on-warning-container: #3E2723;

            /* 阴影 */
            --md-shadow-1: 0 1px 2px 0 rgba(0,0,0,0.3), 0 1px 3px 1px rgba(0,0,0,0.15);
            --md-shadow-2: 0 1px 2px 0 rgba(0,0,0,0.3), 0 2px 6px 2px rgba(0,0,0,0.15);
            --md-shadow-3: 0 4px 8px 3px rgba(0,0,0,0.15), 0 1px 3px 0 rgba(0,0,0,0.3);
            --md-shadow-4: 0 6px 10px 4px rgba(0,0,0,0.15), 0 2px 3px 0 rgba(0,0,0,0.15);

            /* 圆角 */
            --md-radius-sm: 4px;
            --md-radius-md: 8px;
            --md-radius-lg: 12px;
            --md-radius-xl: 16px;
            --md-radius-full: 9999px;

            /* 过渡 */
            --md-duration-short: 150ms;
            --md-duration-medium: 250ms;
            --md-easing-standard: cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* 深色主题 */
        [data-theme="dark"] {
            --md-primary: #A8C7FA;
            --md-primary-light: #D3E3FD;
            --md-primary-dark: #4285F4;
            --md-on-primary: #041E49;
            --md-primary-container: #041E49;
            --md-on-primary-container: #D3E3FD;

            --md-surface: #1C1B1F;
            --md-surface-variant: #2B2930;
            --md-surface-container: #211F26;
            --md-on-surface: #E6E1E5;
            --md-on-surface-variant: #938F99;

            --md-outline: #938F99;
            --md-outline-variant: #49454F;

            --md-error: #F2B8B5;
            --md-on-error: #601410;
            --md-error-container: #8C1D18;
            --md-on-error-container: #F9DEDC';

            --md-success: #81C784;
            --md-success-container: #1B5E20;
            --md-on-success-container: #C8E6C9;

            --md-warning: #FFB74D;
            --md-warning-container: #E65100;
            --md-on-warning-container: #FFE0B2;

            --md-shadow-1: 0 1px 2px 0 rgba(0,0,0,0.5), 0 1px 3px 1px rgba(0,0,0,0.3);
            --md-shadow-2: 0 1px 2px 0 rgba(0,0,0,0.5), 0 2px 6px 2px rgba(0,0,0,0.3);
            --md-shadow-3: 0 4px 8px 3px rgba(0,0,0,0.3), 0 1px 3px 0 rgba(0,0,0,0.5);
            --md-shadow-4: 0 6px 10px 4px rgba(0,0,0,0.3), 0 2px 3px 0 rgba(0,0,0,0.5);
        }

        /* ============================================
           基础样式重置
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei UI', sans-serif;
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
            line-height: 1.5;
            overflow: hidden;
        }

        /* 图标样式 */
        .icon {
            display: inline-block;
            font-style: normal;
            text-align: center;
            line-height: 1;
        }

        /* Material Icons 样式 */
        .material-icons-outlined {
            font-size: inherit;
            vertical-align: middle;
        }

        /* ============================================
           登录界面
           ============================================ */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--md-primary) 0%, var(--md-primary-dark) 100%);
            padding: 20px;
        }

        .login-card {
            background: var(--md-surface);
            border-radius: var(--md-radius-xl);
            padding: 40px;
            box-shadow: var(--md-shadow-4);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header .logo-icon {
            font-size: 48px;
            color: var(--md-primary);
            margin-bottom: 16px;
            display: flex;
            justify-content: center;
        }

        .login-header .logo-icon .material-icons-outlined {
            font-size: 48px;
        }

        .login-header h4 {
            color: var(--md-on-surface);
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .login-header p {
            color: var(--md-on-surface-variant);
            font-size: 14px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--md-radius-md);
            font-size: 16px;
            background: var(--md-surface);
            color: var(--md-on-surface);
            transition: all var(--md-duration-short) var(--md-easing-standard);
            margin-bottom: 16px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px var(--md-primary-container);
        }

        .login-input::placeholder {
            color: var(--md-on-surface-variant);
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: var(--md-primary);
            color: var(--md-on-primary);
            border: none;
            border-radius: var(--md-radius-full);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--md-duration-medium) var(--md-easing-standard);
        }

        .login-btn:hover {
            background: var(--md-primary-dark);
            box-shadow: var(--md-shadow-2);
        }

        .login-btn:active {
            transform: scale(0.98);
        }

        .login-message {
            margin-top: 16px;
            padding: 12px;
            border-radius: var(--md-radius-md);
            font-size: 14px;
            text-align: center;
            background: var(--md-error-container);
            color: var(--md-on-error-container);
            display: none;
        }

        .login-message.show {
            display: block;
        }

        /* ============================================
           主界面布局
           ============================================ */
        .main-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* ============================================
           Header (固定顶部导航栏)
           ============================================ */
        .md-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: var(--md-surface);
            border-bottom: 1px solid var(--md-outline-variant);
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
            box-shadow: var(--md-shadow-1);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 200px;
        }

        .header-brand .icon {
            font-size: 24px;
            color: var(--md-primary);
        }

        .header-brand .icon .material-icons-outlined {
            font-size: 24px;
        }

        .header-brand span:last-child {
            font-size: 20px;
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .header-search {
            flex: 1;
            max-width: 500px;
            margin: 0 16px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--md-surface-variant);
            border-radius: var(--md-radius-full);
            padding: 8px 16px;
            border: 1px solid transparent;
            transition: all var(--md-duration-short) var(--md-easing-standard);
        }

        .search-box:focus-within {
            background: var(--md-surface);
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px var(--md-primary-container);
        }

        .search-box .icon {
            color: var(--md-on-surface-variant);
            font-size: 18px;
            display: flex;
            align-items: center;
        }

        .search-box .icon .material-icons-outlined {
            font-size: 18px;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 4px 8px;
            font-size: 16px;
            color: var(--md-on-surface);
        }

        .search-box input:focus {
            outline: none;
        }

        .search-box input::placeholder {
            color: var(--md-on-surface-variant);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--md-on-surface-variant);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--md-duration-short) var(--md-easing-standard);
            font-size: 18px;
        }

        .icon-btn:hover {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
        }

        .icon-btn.active {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px 6px 6px;
            border-radius: var(--md-radius-full);
            cursor: pointer;
            transition: all var(--md-duration-short) var(--md-easing-standard);
        }

        .user-menu:hover {
            background: var(--md-surface-variant);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--md-primary);
            color: var(--md-on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .user-name {
            font-size: 14px;
            color: var(--md-on-surface);
        }

        /* 用户菜单下拉 */
        .user-dropdown {
            position: absolute;
            top: 56px;
            right: 16px;
            min-width: 240px;
            background: var(--md-surface);
            border-radius: var(--md-radius-md);
            box-shadow: var(--md-shadow-4);
            padding: 8px 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all var(--md-duration-short) var(--md-easing-standard);
            z-index: 100;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
        }

        .dropdown-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--md-primary);
            color: var(--md-on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 18px;
        }

        .dropdown-info {
            flex: 1;
            min-width: 0;
        }

        .dropdown-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-on-surface);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-email {
            font-size: 12px;
            color: var(--md-on-surface-variant);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--md-outline-variant);
            margin: 8px 0;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background var(--md-duration-short) var(--md-easing-standard);
        }

        .dropdown-item:hover {
            background: var(--md-surface-variant);
        }

        .dropdown-item.danger {
            color: var(--md-error);
        }

        .dropdown-item.danger:hover {
            background: rgba(179, 38, 30, 0.08);
        }

        .dropdown-item .icon {
            display: flex;
            align-items: center;
        }

        .dropdown-item .icon .material-icons-outlined {
            font-size: 20px;
            color: var(--md-on-surface-variant);
        }

        .dropdown-item.danger .icon .material-icons-outlined {
            color: var(--md-error);
        }

        /* ============================================
           Sidebar (侧边栏)
           ============================================ */
        .md-sidebar {
            width: 200px;
            background: var(--md-surface);
            border-right: 1px solid var(--md-outline-variant);
            display: flex;
            flex-direction: column;
            padding-top: 64px;
            flex-shrink: 0;
        }

        .sidebar-nav {
            padding: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--md-radius-full);
            color: var(--md-on-surface-variant);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--md-duration-short) var(--md-easing-standard);
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
        }

        .nav-item.active {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
        }

        .nav-item .icon {
            font-size: 20px;
        }

        .nav-item span:last-child {
            font-size: 14px;
            font-weight: 500;
        }

        .sidebar-divider {
            height: 1px;
            background: var(--md-outline-variant);
            margin: 16px 8px;
        }

        .sidebar-storage {
            padding: 0 16px;
        }

        .storage-info {
            margin-bottom: 12px;
        }

        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .storage-label {
            font-size: 12px;
            color: var(--md-on-surface-variant);
        }

        .storage-value {
            font-size: 12px;
            color: var(--md-on-surface);
            font-weight: 500;
        }

        .storage-bar {
            height: 4px;
            background: var(--md-surface-variant);
            border-radius: 2px;
            overflow: hidden;
        }

        .storage-bar-fill {
            height: 100%;
            background: var(--md-primary);
            border-radius: 2px;
            transition: width var(--md-duration-medium) var(--md-easing-standard);
        }

        /* ============================================
           Main Content (主内容区)
           ============================================ */
        .md-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding-top: 64px;
            overflow: hidden;
            background: var(--md-surface-variant);
        }

        .content-toolbar {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--md-surface);
            border-bottom: 1px solid var(--md-outline-variant);
            gap: 12px;
            flex-wrap: wrap;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--md-on-surface-variant);
            font-size: 14px;
            overflow: hidden;
        }

        .breadcrumb .icon {
            font-size: 16px;
        }

        .breadcrumb a {
            color: var(--md-on-surface-variant);
            text-decoration: none;
            white-space: nowrap;
            transition: color var(--md-duration-short) var(--md-easing-standard);
        }

        .breadcrumb a:hover {
            color: var(--md-primary);
        }

        .breadcrumb .separator {
            color: var(--md-outline-variant);
        }

        .breadcrumb .current {
            color: var(--md-on-surface);
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .toolbar-spacer {
            flex: 1;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: var(--md-radius-full);
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--md-duration-short) var(--md-easing-standard);
        }

        .btn-primary {
            background: var(--md-primary);
            color: var(--md-on-primary);
        }

        .btn-primary:hover {
            background: var(--md-primary-dark);
            box-shadow: var(--md-shadow-1);
        }

        .btn-tonal {
            background: var(--md-surface-variant);
            color: var(--md-on-surface);
        }

        .btn-tonal:hover {
            background: var(--md-surface-container);
        }

        .btn-danger {
            background: var(--md-error-container);
            color: var(--md-on-error-container);
        }

        .btn-danger:hover {
            background: var(--md-error);
            color: var(--md-on-error);
        }

        .btn .icon {
            font-size: 18px;
            display: flex;
            align-items: center;
        }

        .btn .icon .material-icons-outlined {
            font-size: 18px;
        }

        /* ============================================
           File Views (文件视图)
           ============================================ */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* 列表视图 */
        .file-list-view {
            background: var(--md-surface);
            border-radius: var(--md-radius-lg);
            overflow: hidden;
            box-shadow: var(--md-shadow-1);
        }

        .list-header {
            display: grid;
            grid-template-columns: 48px 1fr 120px 160px 120px;
            padding: 12px 16px;
            background: var(--md-surface-variant);
            border-bottom: 1px solid var(--md-outline-variant);
            font-size: 12px;
            font-weight: 500;
            color: var(--md-on-surface-variant);
        }

        .list-header span {
            display: flex;
            align-items: center;
        }

        .list-body {
            max-height: calc(100vh - 220px);
            overflow-y: auto;
        }

        .list-item {
            display: grid;
            grid-template-columns: 48px 1fr 120px 160px 120px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--md-outline-variant);
            align-items: center;
            cursor: pointer;
            transition: background var(--md-duration-short) var(--md-easing-standard);
        }

        .list-item:hover {
            background: var(--md-surface-variant);
        }

        .list-item.selected {
            background: var(--md-primary-container);
        }

        .list-item .checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .list-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--md-primary);
        }

        .list-item .file-icon {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-item .file-icon .icon {
            font-size: 22px;
            display: flex;
            align-items: center;
        }

        .list-item .file-icon .icon .material-icons-outlined {
            font-size: 22px;
        }

        .list-item .file-name {
            font-size: 14px;
            color: var(--md-on-surface);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .list-item .file-size,
        .list-item .file-date {
            font-size: 13px;
            color: var(--md-on-surface-variant);
        }

        .list-item .file-actions {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
        }

        /* 网格视图 */
        .file-grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
        }

        .grid-item {
            background: var(--md-surface);
            border-radius: var(--md-radius-md);
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all var(--md-duration-short) var(--md-easing-standard);
            box-shadow: var(--md-shadow-1);
            position: relative;
        }

        .grid-item:hover {
            box-shadow: var(--md-shadow-2);
            transform: translateY(-2px);
        }

        .grid-item.selected {
            background: var(--md-primary-container);
        }

        .grid-item .checkbox-wrapper {
            position: absolute;
            top: 8px;
            left: 8px;
        }

        .grid-item .checkbox-wrapper input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--md-primary);
        }

        .grid-item .item-icon {
            font-size: 48px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .grid-item .item-icon .material-icons-outlined {
            font-size: 48px;
        }

        .grid-item .item-name {
            font-size: 13px;
            color: var(--md-on-surface);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }

        .grid-item .item-meta {
            font-size: 11px;
            color: var(--md-on-surface-variant);
            margin-top: 4px;
        }

        /* 空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: var(--md-on-surface-variant);
        }

        .empty-state .icon {
            font-size: 64px;
            opacity: 0.5;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state .icon .material-icons-outlined {
            font-size: 64px;
        }

        .empty-state p {
            font-size: 16px;
        }

        /* ============================================
           上下文菜单
           ============================================ */
        .context-menu {
            position: fixed;
            background: var(--md-surface);
            border-radius: var(--md-radius-md);
            box-shadow: var(--md-shadow-3);
            padding: 8px;
            min-width: 160px;
            z-index: 1000;
            display: none;
        }

        .context-menu.show {
            display: block;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: var(--md-radius-sm);
            color: var(--md-on-surface);
            font-size: 14px;
            cursor: pointer;
            transition: background var(--md-duration-short) var(--md-easing-standard);
        }

        .context-menu-item:hover {
            background: var(--md-surface-variant);
        }

        .context-menu-item .icon {
            font-size: 18px;
            color: var(--md-on-surface-variant);
            display: flex;
            align-items: center;
        }

        .context-menu-item .icon .material-icons-outlined {
            font-size: 18px;
        }

        .context-menu-item.danger {
            color: var(--md-error);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--md-outline-variant);
            margin: 4px 0;
        }

        /* ============================================
           对话框
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--md-duration-medium) var(--md-easing-standard);
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--md-surface);
            border-radius: var(--md-radius-xl);
            box-shadow: var(--md-shadow-4);
            min-width: 320px;
            max-width: 480px;
            transform: scale(0.9);
            transition: transform var(--md-duration-medium) var(--md-easing-standard);
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px 24px 16px;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 500;
            color: var(--md-on-surface);
        }

        .modal-body {
            padding: 0 24px 20px;
        }

        .modal-body .input-group {
            margin-bottom: 16px;
        }

        .modal-body label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--md-on-surface-variant);
            margin-bottom: 8px;
        }

        .modal-body input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--md-radius-md);
            font-size: 16px;
            background: var(--md-surface);
            color: var(--md-on-surface);
        }

        .modal-body input:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px var(--md-primary-container);
        }

        .modal-footer {
            padding: 12px 24px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* 设置对话框样式 */
        .settings-container {
            max-height: 400px;
            overflow-y: auto;
            padding: 8px 0;
        }

        .settings-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .settings-section h4 {
            font-size: 14px;
            font-weight: 500;
            color: var(--md-on-surface);
            margin-bottom: 12px;
        }

        .setting-item {
            margin-bottom: 12px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-item label {
            display: block;
            font-size: 13px;
            color: var(--md-on-surface-variant);
            margin-bottom: 6px;
        }

        .setting-item select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--md-radius-md);
            background: var(--md-surface);
            color: var(--md-on-surface);
            font-size: 14px;
        }

        .setting-item select:focus {
            outline: none;
            border-color: var(--md-primary);
            box-shadow: 0 0 0 2px var(--md-primary-container);
        }

        .setting-item input[type="checkbox"] {
            margin-right: 8px;
            accent-color: var(--md-primary);
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }

        .setting-item input[type="checkbox"] + label {
            display: inline;
        }

        /* 用户信息对话框样式 */
        .user-info-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
        }

        .user-info-avatar {
            margin-bottom: 20px;
        }

        .user-info-avatar-circle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: var(--md-primary);
            color: var(--md-on-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 500;
        }

        .user-info-details {
            width: 100%;
            max-width: 300px;
        }

        .user-info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--md-outline-variant);
        }

        .user-info-row:last-child {
            border-bottom: none;
        }

        .user-info-label {
            font-size: 13px;
            color: var(--md-on-surface-variant);
        }

        .user-info-value {
            font-size: 14px;
            color: var(--md-on-surface);
            font-weight: 500;
        }

        /* 修改密码对话框样式 */
        .change-password-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 8px 0;
        }

        /* ============================================
           通知 Toast
           ============================================ */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--md-surface);
            border-radius: var(--md-radius-md);
            box-shadow: var(--md-shadow-3);
            min-width: 280px;
            max-width: 400px;
            animation: toastIn var(--md-duration-medium) var(--md-easing-standard);
        }

        @keyframes toastIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            background: var(--md-success-container);
            color: var(--md-on-success-container);
        }

        .toast.error {
            background: var(--md-error-container);
            color: var(--md-on-error-container);
        }

        .toast.info {
            background: var(--md-primary-container);
            color: var(--md-on-primary-container);
        }

        .toast .icon {
            font-size: 20px;
            display: flex;
            align-items: center;
        }

        .toast .icon .material-icons-outlined {
            font-size: 20px;
        }

        .toast-close .icon .material-icons-outlined {
            font-size: 18px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
        }

        .toast-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px;
            opacity: 0.7;
            display: flex;
            align-items: center;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .toast-close .icon {
            display: flex;
            align-items: center;
        }

        .toast-close .icon .material-icons-outlined {
            font-size: 18px;
        }

        /* ============================================
           文件类型图标颜色
           ============================================ */
        .icon-folder { color: #FFB300; }
        .icon-image { color: #4CAF50; }
        .icon-video { color: #E91E63; }
        .icon-audio { color: #9C27B0; }
        .icon-document { color: #2196F3; }
        .icon-archive { color: #FF9800; }
        .icon-code { color: #00BCD4; }
        .icon-default { color: var(--md-on-surface-variant); }

        [data-theme="dark"] .icon-folder { color: #FFCA28; }
        [data-theme="dark"] .icon-image { color: #66BB6A; }
        [data-theme="dark"] .icon-video { color: #F06292; }
        [data-theme="dark"] .icon-audio { color: #BA68C8; }
        [data-theme="dark"] .icon-document { color: #42A5F5; }
        [data-theme="dark"] .icon-archive { color: #FFB74D; }
        [data-theme="dark"] .icon-code { color: #26C6DA; }

        /* ============================================
           上传区域
           ============================================ */
        .upload-zone {
            border: 2px dashed var(--md-outline-variant);
            border-radius: var(--md-radius-lg);
            padding: 32px;
            text-align: center;
            background: var(--md-surface-variant);
            transition: all var(--md-duration-short) var(--md-easing-standard);
            margin-bottom: 16px;
        }

        .upload-zone:hover,
        .upload-zone.drag-over {
            border-color: var(--md-primary);
            background: var(--md-primary-container);
        }

        .upload-zone .icon {
            font-size: 48px;
            color: var(--md-on-surface-variant);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-zone .icon .material-icons-outlined {
            font-size: 48px;
        }

        .upload-zone p {
            color: var(--md-on-surface-variant);
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* ============================================
           响应式设计
           ============================================ */
        @media (max-width: 1024px) {
            .list-header .file-date,
            .list-item .file-date {
                display: none;
            }

            .list-header,
            .list-item {
                grid-template-columns: 48px 1fr 120px 100px;
            }
        }

        @media (max-width: 768px) {
            .md-sidebar {
                position: fixed;
                left: -200px;
                top: 0;
                bottom: 0;
                z-index: 150;
                transition: left var(--md-duration-medium) var(--md-easing-standard);
            }

            .md-sidebar.open {
                left: 0;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 140;
                display: none;
            }

            .sidebar-overlay.show {
                display: block;
            }

            .menu-toggle {
                display: flex !important;
            }

            .header-search {
                display: none;
            }

            .list-header .file-size,
            .list-item .file-size {
                display: none;
            }

            .list-header,
            .list-item {
                grid-template-columns: 48px 1fr 100px;
            }

            .file-grid-view {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .breadcrumb {
                font-size: 12px;
            }

            .btn span:not(.icon) {
                display: none;
            }
        }

        @media (min-width: 769px) {
            .menu-toggle {
                display: none !important;
            }
        }

        /* ============================================
           汉堡菜单动画
           ============================================ */
        .hamburger {
            width: 24px;
            height: 2px;
            background: var(--md-on-surface);
            position: relative;
            transition: all var(--md-duration-medium) var(--md-easing-standard);
        }

        .hamburger::before,
        .hamburger::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 2px;
            background: var(--md-on-surface);
            transition: all var(--md-duration-medium) var(--md-easing-standard);
        }

        .hamburger::before {
            top: -8px;
        }

        .hamburger::after {
            bottom: -8px;
        }

        .menu-toggle.active .hamburger {
            background: transparent;
        }

        .menu-toggle.active .hamburger::before {
            transform: rotate(45deg);
            top: 0;
        }

        .menu-toggle.active .hamburger::after {
            transform: rotate(-45deg);
            bottom: 0;
        }

        /* ============================================
           加载动画
           ============================================ */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--md-outline-variant);
            border-top-color: var(--md-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ============================================
           工具提示
           ============================================ */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 10px;
            background: var(--md-on-surface);
            color: var(--md-surface);
            font-size: 12px;
            border-radius: var(--md-radius-sm);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all var(--md-duration-short) var(--md-easing-standard);
            margin-bottom: 8px;
        }

        [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <span class="icon logo-icon"><span class="material-icons-outlined">folder</span></span>
                <h4>FilePy 文件服务器</h4>
                <p>安全可靠的文件管理解决方案</p>
            </div>
            <div class="login-form">
                <input type="text" class="login-input" id="username" placeholder="用户名" required>
                <input type="password" class="login-input" id="password" placeholder="密码" required>
                <button class="login-btn" onclick="login()">
                    <span class="icon"><span class="material-icons-outlined">login</span></span>
                    登录
                </button>
                <div class="login-message" id="loginMessage"></div>
            </div>
        </div>
    </div>

    <!-- 主界面 -->
    <div id="mainContainer" class="main-container" style="display: none;">
        <!-- Header -->
        <header class="md-header">
            <div class="header-brand">
                <button class="icon-btn menu-toggle" onclick="toggleSidebar()">
                    <div class="hamburger"></div>
                </button>
                <span class="icon"><span class="material-icons-outlined">folder</span></span>
                <span>FilePy</span>
            </div>
            <div class="header-search">
                <div class="search-box">
                    <span class="icon"><span class="material-icons-outlined">search</span></span>
                    <input type="text" id="headerSearchInput" placeholder="搜索文件..." onkeypress="if(event.key==='Enter'){searchFiles();}">
                </div>
            </div>
            <div class="header-actions">
                <button class="icon-btn" onclick="toggleTheme()" data-tooltip="切换主题">
                    <span class="icon" id="themeIcon"><span class="material-icons-outlined">dark_mode</span></span>
                </button>
                <button class="icon-btn" onclick="toggleView()" data-tooltip="切换视图">
                    <span class="icon" id="viewIcon"><span class="material-icons-outlined">view_list</span></span>
                </button>
                <button class="icon-btn" onclick="refreshFiles()" data-tooltip="刷新">
                    <span class="icon"><span class="material-icons-outlined">refresh</span></span>
                </button>
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span class="user-name" id="userName">管理员</span>
                    <span class="icon"><span class="material-icons-outlined">expand_more</span></span>
                </div>
                <!-- 用户菜单下拉 -->
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-avatar" id="dropdownAvatar">A</div>
                        <div class="dropdown-info">
                            <div class="dropdown-name" id="dropdownName">管理员</div>
                            <div class="dropdown-email" id="dropdownEmail">admin</div>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="showUserInfo()">
                        <span class="icon"><span class="material-icons-outlined">person</span></span>
                        <span>用户信息</span>
                    </div>
                    <div class="dropdown-item" onclick="showChangePassword()">
                        <span class="icon"><span class="material-icons-outlined">lock</span></span>
                        <span>修改密码</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item danger" onclick="logout()">
                        <span class="icon"><span class="material-icons-outlined">logout</span></span>
                        <span>退出登录</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar -->
        <aside class="md-sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <a class="nav-item active" onclick="loadFiles()">
                    <span class="icon"><span class="material-icons-outlined">folder</span></span>
                    <span>全部文件</span>
                </a>
                <a class="nav-item" onclick="showRecentFiles()">
                    <span class="icon"><span class="material-icons-outlined">schedule</span></span>
                    <span>最近</span>
                </a>
                <a class="nav-item" onclick="showStarredFiles()">
                    <span class="icon"><span class="material-icons-outlined">star</span></span>
                    <span>收藏</span>
                </a>
            </nav>
            <div class="sidebar-divider"></div>
            <div class="sidebar-storage">
                <div class="storage-info">
                    <div class="storage-header">
                        <span class="storage-label">存储空间</span>
                        <span class="storage-value" id="storageValue">2.4 GB / 10 GB</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-bar-fill" id="storageBarFill" style="width: 24%;"></div>
                    </div>
                </div>
            </div>
            <div class="sidebar-divider"></div>
            <nav class="sidebar-nav">
                <a class="nav-item" onclick="showSettings()">
                    <span class="icon"><span class="material-icons-outlined">settings</span></span>
                    <span>设置</span>
                </a>
                <a class="nav-item" onclick="logout()">
                    <span class="icon"><span class="material-icons-outlined">logout</span></span>
                    <span>退出登录</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="md-main">
            <!-- Toolbar -->
            <div class="content-toolbar">
                <button class="icon-btn" onclick="navigateUp()" data-tooltip="返回上一级" id="backButton" style="margin-right: 8px;">
                    <span class="icon"><span class="material-icons-outlined">arrow_back</span></span>
                </button>
                <div class="breadcrumb" id="breadcrumb">
                    <a href="#" onclick="navigateTo('/')">
                        <span class="icon"><span class="material-icons-outlined">home</span></span>
                    </a>
                    <span class="separator">/</span>
                    <span class="current" id="currentPathName">全部文件</span>
                </div>
                <div class="toolbar-spacer"></div>
                <label class="btn btn-tonal" style="padding: 8px 12px;">
                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll()" style="margin: 0;">
                    全选
                </label>
                <button class="btn btn-primary" onclick="createNewFolder()">
                    <span class="icon"><span class="material-icons-outlined">create_new_folder</span></span>
                    <span>新建文件夹</span>
                </button>
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <span class="icon"><span class="material-icons-outlined">upload</span></span>
                    <span>上传</span>
                </button>
                <button class="btn btn-danger" onclick="batchDelete()" id="batchDeleteBtn" style="display: none;">
                    <span class="icon"><span class="material-icons-outlined">delete</span></span>
                </button>
                <button class="btn btn-tonal" onclick="batchDownload()" id="batchDownloadBtn" style="display: none;">
                    <span class="icon"><span class="material-icons-outlined">download</span></span>
                </button>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Upload Zone -->
                <div class="upload-zone" id="uploadZone">
                    <span class="icon"><span class="material-icons-outlined">cloud_upload</span></span>
                    <p>拖拽文件到此处上传，或点击下方按钮选择文件</p>
                    <button class="btn btn-tonal" onclick="document.getElementById('fileInput').click()">
                        <span class="icon"><span class="material-icons-outlined">folder_open</span></span>
                        选择文件
                    </button>
                    <div id="selectedFileInfo" style="margin-top: 12px; color: var(--md-success); font-size: 13px;"></div>
                </div>

                <!-- File Container -->
                <div id="fileContainer">
                    <div class="file-list-view" id="listView">
                        <div class="list-header">
                            <span></span>
                            <span>名称</span>
                            <span>大小</span>
                            <span>修改时间</span>
                            <span>操作</span>
                        </div>
                        <div class="list-body" id="fileList">
                            <div class="empty-state">
                                <span class="icon"><span class="material-icons-outlined">inbox</span></span>
                                <p>加载中...</p>
                            </div>
                        </div>
                    </div>
                    <div class="file-grid-view" id="gridView" style="display: none;"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- 上下文菜单 -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="contextMenuAction('open')">
            <span class="icon"><span class="material-icons-outlined">folder_open</span></span>
            打开
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('download')">
            <span class="icon"><span class="material-icons-outlined">download</span></span>
            下载
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="contextMenuAction('favorite')">
            <span class="icon"><span class="material-icons-outlined">star</span></span>
            收藏
        </div>
        <div class="context-menu-item" onclick="contextMenuAction('rename')">
            <span class="icon"><span class="material-icons-outlined">edit</span></span>
            重命名
        </div>
        <div class="context-menu-item danger" onclick="contextMenuAction('delete')">
            <span class="icon"><span class="material-icons-outlined">delete</span></span>
            删除
        </div>
    </div>

    <!-- 对话框容器 -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h3 id="modalTitle">标题</h3>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- 动态内容 -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-tonal" onclick="closeModal()">取消</button>
                <button class="btn btn-primary" id="modalConfirm">确认</button>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="fileInput" multiple style="display: none;" onchange="handleFilesSelect(this.files)">

    <script>
        // ============================================
        // 全局状态
        // ============================================
        let authToken = null;
        let currentUser = null;
        let allFiles = [];
        let currentPath = "/";
        let currentView = "list"; // list | grid
        let currentTheme = "light";
        let contextMenuItem = null;

        // ============================================
        // 文件类型图标映射
        // ============================================
        const FILE_TYPE_ICONS = {
            folder: { icon: 'folder', class: 'icon-folder' },
            // 图片
            image: { icon: 'image', class: 'icon-image' },
            img: { icon: 'image', class: 'icon-image' },
            jpg: { icon: 'image', class: 'icon-image' },
            jpeg: { icon: 'image', class: 'icon-image' },
            png: { icon: 'image', class: 'icon-image' },
            gif: { icon: 'image', class: 'icon-image' },
            webp: { icon: 'image', class: 'icon-image' },
            bmp: { icon: 'image', class: 'icon-image' },
            svg: { icon: 'image', class: 'icon-image' },
            // 视频
            video: { icon: 'movie', class: 'icon-video' },
            mp4: { icon: 'movie', class: 'icon-video' },
            avi: { icon: 'movie', class: 'icon-video' },
            mkv: { icon: 'movie', class: 'icon-video' },
            mov: { icon: 'movie', class: 'icon-video' },
            webm: { icon: 'movie', class: 'icon-video' },
            // 音频
            audio: { icon: 'audiotrack', class: 'icon-audio' },
            mp3: { icon: 'audiotrack', class: 'icon-audio' },
            wav: { icon: 'audiotrack', class: 'icon-audio' },
            flac: { icon: 'audiotrack', class: 'icon-audio' },
            ogg: { icon: 'audiotrack', class: 'icon-audio' },
            // 文档
            document: { icon: 'description', class: 'icon-document' },
            pdf: { icon: 'picture_as_pdf', class: 'icon-document' },
            doc: { icon: 'description', class: 'icon-document' },
            docx: { icon: 'description', class: 'icon-document' },
            txt: { icon: 'text_snippet', class: 'icon-document' },
            xls: { icon: 'table_view', class: 'icon-document' },
            xlsx: { icon: 'table_view', class: 'icon-document' },
            ppt: { icon: 'slideshow', class: 'icon-document' },
            pptx: { icon: 'slideshow', class: 'icon-document' },
            // 压缩包
            archive: { icon: 'folder_zip', class: 'icon-archive' },
            zip: { icon: 'folder_zip', class: 'icon-archive' },
            rar: { icon: 'folder_zip', class: 'icon-archive' },
            '7z': { icon: 'folder_zip', class: 'icon-archive' },
            tar: { icon: 'folder_zip', class: 'icon-archive' },
            gz: { icon: 'folder_zip', class: 'icon-archive' },
            // 代码
            code: { icon: 'code', class: 'icon-code' },
            js: { icon: 'javascript', class: 'icon-code' },
            py: { icon: 'code', class: 'icon-code' },
            html: { icon: 'code', class: 'icon-code' },
            css: { icon: 'code', class: 'icon-code' },
            json: { icon: 'data_object', class: 'icon-code' },
            xml: { icon: 'data_object', class: 'icon-code' },
            md: { icon: 'description', class: 'icon-code' },
            // 其他
            default: { icon: 'insert_drive_file', class: 'icon-default' }
        };

        function getFileTypeIcon(filename, isDir) {
            if (isDir) return FILE_TYPE_ICONS.folder;

            const ext = filename.split('.').pop().toLowerCase();
            return FILE_TYPE_ICONS[ext] || FILE_TYPE_ICONS.default;
        }

        function getIconHtml(iconData) {
            return `<span class="material-icons-outlined ${iconData.class}">${iconData.icon}</span>`;
        }

        // ============================================
        // 初始化
        // ============================================
        window.onload = function() {
            // 检查保存的主题
            const savedTheme = localStorage.getItem('filepy_theme');
            if (savedTheme) {
                currentTheme = savedTheme;
                document.documentElement.setAttribute('data-theme', currentTheme);
                updateThemeIcon();
            }

            // 检查认证状态
            const storedToken = localStorage.getItem('filepy_token');
            const storedUser = localStorage.getItem('filepy_user');
            if (storedToken) {
                if (isTokenExpired(storedToken)) {
                    localStorage.removeItem('filepy_token');
                    localStorage.removeItem('filepy_user');
                    return;
                }
                authToken = storedToken;
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    updateUserDisplay();
                }
                showMainInterface();
                loadFiles();
            }

            // 设置拖拽上传
            setupDragDrop();

            // 点击其他地方关闭上下文菜单
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.context-menu')) {
                    hideContextMenu();
                }
            });

            // 监听浏览器后退/前进按钮
            window.addEventListener('popstate', function(e) {
                if (e.state && e.state.path) {
                    loadFiles(e.state.path, false);
                } else {
                    loadFiles('/', false);
                }
            });
        };

        function isTokenExpired(token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const exp = payload.exp;
                const now = Math.floor(Date.now() / 1000);
                return exp - now < 300;
            } catch (e) {
                return true;
            }
        }

        // ============================================
        // 认证相关
        // ============================================
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageElement = document.getElementById('loginMessage');

            if (!username || !password) {
                showLoginMessage('用户名和密码不能为空');
                return;
            }

            try {
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    currentUser = {username: username};
                    localStorage.setItem('filepy_token', authToken);
                    localStorage.setItem('filepy_user', JSON.stringify(currentUser));
                    hideLoginMessage();
                    updateUserDisplay();
                    showMainInterface();
                    loadFiles();
                } else {
                    const error = await response.json();
                    showLoginMessage('登录失败: ' + error.detail);
                }
            } catch (error) {
                showLoginMessage('登录请求失败: ' + error.message);
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('filepy_token');
            localStorage.removeItem('filepy_user');
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            hideLoginMessage();
        }

        function showMainInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
        }

        function showLoginMessage(message) {
            const messageElement = document.getElementById('loginMessage');
            messageElement.textContent = message;
            messageElement.classList.add('show');
        }

        function hideLoginMessage() {
            document.getElementById('loginMessage').classList.remove('show');
        }

        function updateUserDisplay() {
            if (currentUser) {
                const avatar = currentUser.username.charAt(0).toUpperCase();
                document.getElementById('userAvatar').textContent = avatar;
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('dropdownAvatar').textContent = avatar;
                document.getElementById('dropdownName').textContent = currentUser.username;
                document.getElementById('dropdownEmail').textContent = currentUser.email || currentUser.username;
            }
        }

        // ============================================
        // 主题切换
        // ============================================
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('filepy_theme', currentTheme);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const iconEl = document.querySelector('#themeIcon .material-icons-outlined');
            iconEl.textContent = currentTheme === 'light' ? 'dark_mode' : 'light_mode';
        }

        // ============================================
        // 视图切换
        // ============================================
        function toggleView() {
            currentView = currentView === 'list' ? 'grid' : 'list';
            document.getElementById('listView').style.display = currentView === 'list' ? 'block' : 'none';
            document.getElementById('gridView').style.display = currentView === 'grid' ? 'grid' : 'none';
            const iconEl = document.querySelector('#viewIcon .material-icons-outlined');
            iconEl.textContent = currentView === 'list' ? 'view_list' : 'grid_view';
            displayFiles(allFiles);
        }

        // ============================================
        // 侧边栏切换
        // ============================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const menuToggle = document.querySelector('.menu-toggle');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            menuToggle.classList.toggle('active');
        }

        // ============================================
        // 文件加载与显示
        // ============================================
        async function loadFiles(path = null, pushState = true) {
            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            const targetPath = path !== null ? path : currentPath;
            const previousPath = currentPath;

            try {
                const response = await fetch(`/files?path=${encodeURIComponent(targetPath)}`, {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });

                if (response.ok) {
                    const files = await response.json();
                    allFiles = files;
                    currentPath = targetPath;
                    updateBreadcrumb();
                    displayFiles(files);

                    // 更新浏览器历史记录（仅在路径实际改变时）
                    if (pushState && targetPath !== previousPath) {
                        history.pushState({ path: targetPath }, '', `#path=${encodeURIComponent(targetPath)}`);
                    }
                } else {
                    showToast('加载文件列表失败', 'error');
                }
            } catch (error) {
                showToast('加载文件列表失败: ' + error.message, 'error');
            }
        }

        function displayFiles(files) {
            const listElement = document.getElementById('fileList');
            const gridElement = document.getElementById('gridView');

            if (!files || files.length === 0) {
                const emptyHtml = `
                    <div class="empty-state">
                        <span class="icon"><span class="material-icons-outlined">inbox</span></span>
                        <p>没有文件</p>
                    </div>
                `;
                listElement.innerHTML = emptyHtml;
                gridElement.innerHTML = emptyHtml;
                return;
            }

            // 列表视图
            listElement.innerHTML = files.map(file => {
                const icon = getFileTypeIcon(file.name, file.is_dir);
                const size = file.is_dir ? '' : formatFileSize(file.size || 0);
                const date = file.modified ? formatDate(file.modified) : '未知';

                return `
                    <div class="list-item" data-is-dir="${file.is_dir}" data-path="${file.path}"
                         ondblclick="${file.is_dir ? `navigateTo('${file.path}')` : `downloadFile('${file.path}')`}"
                         oncontextmenu="showContextMenu(event, '${file.path}', ${file.is_dir})">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="file-checkbox"
                                   data-path="${file.path}"
                                   data-name="${file.name}"
                                   data-is-dir="${file.is_dir}"
                                   onchange="updateBatchButtons()">
                        </div>
                        <div class="file-icon">
                            <span class="icon ${icon.class}">${getIconHtml(icon)}</span>
                            <span class="file-name">${file.name}</span>
                        </div>
                        <span class="file-size">${size}</span>
                        <span class="file-date">${date}</span>
                        <div class="file-actions">
                            <button class="icon-btn" onclick="event.stopPropagation(); toggleFavorite('${file.path}', '${file.name.replace(/'/g, "\\'")}', ${file.is_dir})" data-tooltip="收藏">
                                <span class="icon"><span class="material-icons-outlined">star_border</span></span>
                            </button>
                            <button class="icon-btn" onclick="event.stopPropagation(); renameFile('${file.path}', '${file.name.replace(/'/g, "\\'")}')" data-tooltip="重命名">
                                <span class="icon"><span class="material-icons-outlined">edit</span></span>
                            </button>
                            <button class="icon-btn" onclick="event.stopPropagation(); deleteFile('${file.path}')" data-tooltip="删除">
                                <span class="icon"><span class="material-icons-outlined">delete</span></span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // 网格视图
            gridElement.innerHTML = files.map(file => {
                const icon = getFileTypeIcon(file.name, file.is_dir);
                const size = file.is_dir ? '' : formatFileSize(file.size || 0);

                return `
                    <div class="grid-item" data-is-dir="${file.is_dir}" data-path="${file.path}"
                         ondblclick="${file.is_dir ? `navigateTo('${file.path}')` : `downloadFile('${file.path}')`}"
                         oncontextmenu="showContextMenu(event, '${file.path}', ${file.is_dir})">
                        <div class="checkbox-wrapper">
                            <input type="checkbox" class="file-checkbox"
                                   data-path="${file.path}"
                                   data-name="${file.name}"
                                   data-is-dir="${file.is_dir}"
                                   onchange="updateBatchButtons()">
                        </div>
                        <span class="icon item-icon ${icon.class}">${getIconHtml(icon)}</span>
                        <span class="item-name">${file.name}</span>
                        <span class="item-meta">${size}</span>
                    </div>
                `;
            }).join('');
        }

        function updateBreadcrumb() {
            const currentPathName = document.getElementById('currentPathName');
            const backButton = document.getElementById('backButton');

            if (currentPath === '/') {
                currentPathName.textContent = '全部文件';
                backButton.style.display = 'none';
            } else {
                const parts = currentPath.split('/').filter(p => p);
                currentPathName.textContent = parts[parts.length - 1] || '全部文件';
                backButton.style.display = 'flex';
            }
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return '未知';
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }

        function navigateTo(path) {
            loadFiles(path);
        }

        function navigateUp() {
            if (currentPath === '/') return;
            const pathParts = currentPath.split('/').filter(p => p);
            pathParts.pop();
            const parentPath = pathParts.length > 0 ? '/' + pathParts.join('/') : '/';
            loadFiles(parentPath);
        }

        function refreshFiles() {
            loadFiles();
        }

        // ============================================
        // 文件操作
        // ============================================
        async function createNewFolder() {
            showModal('新建文件夹', `
                <div class="input-group">
                    <label>文件夹名称</label>
                    <input type="text" id="folderName" placeholder="请输入文件夹名称" value="新建文件夹">
                </div>
            `, async () => {
                const folderName = document.getElementById('folderName').value;
                if (!folderName || !folderName.trim()) {
                    showToast('文件夹名称不能为空', 'error');
                    return;
                }

                try {
                    const response = await fetch('/files/mkdir', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            path: currentPath,
                            name: folderName.trim()
                        })
                    });

                    if (response.ok) {
                        showToast('文件夹创建成功', 'success');
                        closeModal();
                        loadFiles();
                    } else {
                        const error = await response.json();
                        showToast('文件夹创建失败: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('文件夹创建失败: ' + error.message, 'error');
                }
            });
        }

        async function downloadFile(filePath) {
            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            try {
                const response = await fetch(`/files/download/${filePath}`, {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filePath.split('/').pop();
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    showToast('文件下载失败', 'error');
                }
            } catch (error) {
                showToast('文件下载失败: ' + error.message, 'error');
            }
        }

        async function renameFile(oldPath, oldName) {
            showModal('重命名', `
                <div class="input-group">
                    <label>新名称</label>
                    <input type="text" id="newName" placeholder="请输入新名称" value="${oldName}">
                </div>
            `, async () => {
                const newName = document.getElementById('newName').value;
                if (!newName || !newName.trim() || newName === oldName) {
                    return;
                }

                try {
                    const response = await fetch('/files/rename', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            old_path: oldPath,
                            new_name: newName.trim()
                        })
                    });

                    if (response.ok) {
                        showToast('重命名成功', 'success');
                        closeModal();
                        loadFiles();
                    } else {
                        const error = await response.json();
                        showToast('重命名失败: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('重命名失败: ' + error.message, 'error');
                }
            });
        }

        async function deleteFile(filePath) {
            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            showModal('确认删除', `
                <p>确定要删除这个文件吗？此操作无法撤销。</p>
            `, async () => {
                try {
                    const response = await fetch(`/files/${encodeURIComponent(filePath)}`, {
                        method: 'DELETE',
                        headers: {'Authorization': `Bearer ${authToken}`}
                    });

                    if (response.ok) {
                        showToast('文件删除成功', 'success');
                        closeModal();
                        loadFiles();
                    } else {
                        const error = await response.json();
                        showToast('文件删除失败: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('文件删除失败: ' + error.message, 'error');
                }
            });
        }

        // ============================================
        // 批量操作
        // ============================================
        function getSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-checkbox:checked');
            return Array.from(checkboxes).map(cb => ({
                path: cb.dataset.path,
                name: cb.dataset.name,
                is_dir: cb.dataset.isDir === 'true'
            }));
        }

        function updateBatchButtons() {
            const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const batchDownloadBtn = document.getElementById('batchDownloadBtn');

            if (selectedCount > 0) {
                batchDeleteBtn.style.display = 'inline-flex';
                batchDownloadBtn.style.display = 'inline-flex';
            } else {
                batchDeleteBtn.style.display = 'none';
                batchDownloadBtn.style.display = 'none';
            }
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.file-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateBatchButtons();
        }

        async function batchDelete() {
            const selectedFiles = getSelectedFiles();
            if (selectedFiles.length === 0) {
                showToast('请先选择要删除的文件', 'error');
                return;
            }

            showModal('确认批量删除', `
                <p>确定要删除选中的 ${selectedFiles.length} 个文件吗？此操作无法撤销。</p>
            `, async () => {
                try {
                    const response = await fetch('/files/batch', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            paths: selectedFiles.map(f => f.path)
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showToast(result.message, 'success');
                        closeModal();
                        loadFiles();
                        document.getElementById('selectAll').checked = false;
                        updateBatchButtons();
                    } else {
                        const error = await response.json();
                        showToast('批量删除失败: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('批量删除失败: ' + error.message, 'error');
                }
            });
        }

        async function batchDownload() {
            const selectedFiles = getSelectedFiles();
            if (selectedFiles.length === 0) {
                showToast('请先选择要下载的文件', 'error');
                return;
            }

            const filesOnly = selectedFiles.filter(f => !f.is_dir);
            if (filesOnly.length === 0) {
                showToast('请选择文件进行下载（不支持下载目录）', 'error');
                return;
            }

            for (const file of filesOnly) {
                await downloadFile(file.path);
            }
            showToast(`已开始下载 ${filesOnly.length} 个文件`, 'info');
        }

        // ============================================
        // 搜索功能
        // ============================================
        async function searchFiles() {
            const searchTerm = document.getElementById('headerSearchInput').value.trim();
            if (!searchTerm) {
                loadFiles();
                return;
            }

            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            try {
                const response = await fetch('/files/search', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        path: currentPath,
                        name: searchTerm
                    })
                });

                if (response.ok) {
                    const results = await response.json();
                    allFiles = results;
                    displayFiles(results);
                } else {
                    showToast('搜索失败: ' + (await response.json()).detail, 'error');
                }
            } catch (error) {
                showToast('搜索失败: ' + error.message, 'error');
            }
        }

        // ============================================
        // 拖拽上传
        // ============================================
        function setupDragDrop() {
            const uploadZone = document.getElementById('uploadZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                uploadZone.addEventListener(eventName, function() {
                    uploadZone.classList.add('drag-over');
                });
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadZone.addEventListener(eventName, function() {
                    uploadZone.classList.remove('drag-over');
                });
            });

            uploadZone.addEventListener('drop', function(e) {
                const files = e.dataTransfer.files;
                handleFiles(files);
            });
        }

        async function handleFilesSelect(files) {
            handleFiles(files);
        }

        async function handleFiles(files) {
            if (!files || files.length === 0) return;

            const fileInfo = document.getElementById('selectedFileInfo');
            fileInfo.textContent = `已选择 ${files.length} 个文件`;

            for (const file of files) {
                await uploadFile(file);
            }

            fileInfo.textContent = '';
            showToast(`上传完成 ${files.length} 个文件`, 'success');
            loadFiles();
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('path', currentPath);

            try {
                const response = await fetch('/files/upload', {
                    method: 'POST',
                    headers: {'Authorization': `Bearer ${authToken}`},
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    showToast(`上传 ${file.name} 失败: ${error.detail}`, 'error');
                }
            } catch (error) {
                showToast(`上传 ${file.name} 失败: ${error.message}`, 'error');
            }
        }

        // ============================================
        // 上下文菜单
        // ============================================
        function showContextMenu(event, path, isDir) {
            event.preventDefault();
            event.stopPropagation();

            contextMenuItem = { path, isDir };

            const menu = document.getElementById('contextMenu');
            menu.style.top = event.clientY + 'px';
            menu.style.left = event.clientX + 'px';
            menu.classList.add('show');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('show');
        }

        function contextMenuAction(action) {
            if (!contextMenuItem) return;

            const { path, isDir } = contextMenuItem;
            const fileName = path.split('/').pop();

            switch (action) {
                case 'open':
                    if (isDir) {
                        navigateTo(path);
                    } else {
                        downloadFile(path);
                    }
                    break;
                case 'download':
                    if (!isDir) {
                        downloadFile(path);
                    } else {
                        showToast('不支持下载目录', 'error');
                    }
                    break;
                case 'favorite':
                    toggleFavorite(path, fileName, isDir);
                    break;
                case 'rename':
                    renameFile(path, fileName);
                    break;
                case 'delete':
                    deleteFile(path);
                    break;
            }

            hideContextMenu();
        }

        // ============================================
        // 对话框
        // ============================================
        function showModal(title, bodyHtml, onConfirm, showCancelButton = true) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = bodyHtml;

            const cancelBtn = document.querySelector('#modalFooter .btn-tonal');
            const confirmBtn = document.getElementById('modalConfirm');

            if (showCancelButton) {
                cancelBtn.style.display = 'block';
                confirmBtn.textContent = '确认';
            } else {
                cancelBtn.style.display = 'none';
                confirmBtn.textContent = '确定';
            }

            if (onConfirm) {
                confirmBtn.onclick = onConfirm;
                confirmBtn.style.display = 'block';
            } else {
                confirmBtn.style.display = 'none';
            }

            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
        }

        // ============================================
        // Toast 通知
        // ============================================
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const iconMap = {
                success: 'check_circle',
                error: 'error',
                info: 'info'
            };

            toast.innerHTML = `
                <span class="icon"><span class="material-icons-outlined">${iconMap[type] || iconMap.info}</span></span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <span class="icon"><span class="material-icons-outlined">close</span></span>
                </button>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // ============================================
        // 导航占位函数
        // ============================================
        // 最近文件功能
        async function showRecentFiles() {
            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            try {
                const response = await fetch('/files/recent?limit=50', {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });

                if (response.ok) {
                    const recent = await response.json();
                    // 显示最近文件信息
                    displayRecentFiles(recent);
                } else {
                    showToast('加载最近文件失败', 'error');
                }
            } catch (error) {
                showToast('加载最近文件失败: ' + error.message, 'error');
            }
        }

        function displayRecentFiles(recent) {
            const listElement = document.getElementById('fileList');
            const gridElement = document.getElementById('gridView');

            if (!recent || recent.length === 0) {
                const emptyHtml = `
                    <div class="empty-state">
                        <span class="icon"><span class="material-icons-outlined">history</span></span>
                        <p>暂无最近访问记录</p>
                    </div>
                `;
                listElement.innerHTML = emptyHtml;
                gridElement.innerHTML = emptyHtml;
                return;
            }

            // 转换为文件列表格式并显示
            const files = recent.map(r => {
                const path = r.details || '';
                const name = path.split('/').pop() || '未知';
                return {
                    name: name,
                    path: path,
                    is_dir: false,
                    size: null,
                    modified: r.created_at
                };
            });

            displayFiles(files);

            // 更新面包屑
            document.getElementById('currentPathName').textContent = '最近访问';
        }

        // 收藏功能
        async function showStarredFiles() {
            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            try {
                const response = await fetch('/files/favorites', {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });

                if (response.ok) {
                    const favorites = await response.json();
                    const files = favorites.map(f => ({
                        name: f.file_name,
                        path: f.file_path,
                        is_dir: f.is_dir,
                        size: f.file_size
                    }));
                    displayFiles(files);
                    document.getElementById('currentPathName').textContent = '我的收藏';
                } else {
                    showToast('加载收藏失败', 'error');
                }
            } catch (error) {
                showToast('加载收藏失败: ' + error.message, 'error');
            }
        }

        async function toggleFavorite(filePath, fileName, isDir) {
            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            try {
                // 先检查是否已收藏
                const checkResponse = await fetch(`/files/favorites/check/${encodeURIComponent(filePath)}`, {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });
                const checkData = await checkResponse.json();

                if (checkData.is_favorite) {
                    // 取消收藏
                    await fetch(`/files/favorites/${encodeURIComponent(filePath)}`, {
                        method: 'DELETE',
                        headers: {'Authorization': `Bearer ${authToken}`}
                    });
                    showToast('已取消收藏', 'info');
                } else {
                    // 添加收藏
                    await fetch('/files/favorites', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            file_path: filePath,
                            file_name: fileName,
                            is_dir: isDir
                        })
                    });
                    showToast('已添加收藏', 'success');
                }
            } catch (error) {
                showToast('操作失败: ' + error.message, 'error');
            }
        }

        // 设置功能
        async function showSettings() {
            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            // 显示设置对话框
            showModal('设置', `
                <div class="settings-container">
                    <div class="settings-section">
                        <h4>显示设置</h4>
                        <div class="setting-item">
                            <label>主题</label>
                            <select id="settingTheme">
                                <option value="light">浅色</option>
                                <option value="dark">深色</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <label>视图模式</label>
                            <select id="settingViewMode">
                                <option value="list">列表</option>
                                <option value="grid">网格</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>其他设置</h4>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="settingAutoRefresh" checked>
                                上传后自动刷新
                            </label>
                        </div>
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="settingConfirmDelete" checked>
                                删除前确认
                            </label>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h4>存储信息</h4>
                        <div id="storageInfoDisplay">加载中...</div>
                    </div>
                </div>
            `, async () => {
                const settings = {
                    theme: document.getElementById('settingTheme').value,
                    view_mode: document.getElementById('settingViewMode').value,
                    auto_refresh: document.getElementById('settingAutoRefresh').checked,
                    confirm_delete: document.getElementById('settingConfirmDelete').checked
                };

                try {
                    const response = await fetch('/user/settings', {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(settings)
                    });

                    if (response.ok) {
                        showToast('设置保存成功', 'success');
                        closeModal();
                        // 应用主题设置
                        if (settings.theme !== currentTheme) {
                            currentTheme = settings.theme;
                            document.documentElement.setAttribute('data-theme', currentTheme);
                            localStorage.setItem('filepy_theme', currentTheme);
                            updateThemeIcon();
                        }
                    } else {
                        showToast('设置保存失败', 'error');
                    }
                } catch (error) {
                    showToast('设置保存失败: ' + error.message, 'error');
                }
            });

            // 加载当前设置
            loadCurrentSettings();
        }

        async function loadCurrentSettings() {
            try {
                const response = await fetch('/user/settings', {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('settingTheme').value = settings.theme;
                    document.getElementById('settingViewMode').value = settings.view_mode;
                    document.getElementById('settingAutoRefresh').checked = settings.auto_refresh;
                    document.getElementById('settingConfirmDelete').checked = settings.confirm_delete;
                }
            } catch (error) {
                console.error('加载设置失败:', error);
            }

            // 加载存储信息
            loadStorageInfo();
        }

        async function loadStorageInfo() {
            try {
                const response = await fetch('/user/storage');
                if (response.ok) {
                    const info = await response.json();
                    const usedGB = (info.used_space / 1024 / 1024 / 1024).toFixed(2);
                    const totalGB = (info.total_space / 1024 / 1024 / 1024).toFixed(2);
                    document.getElementById('storageInfoDisplay').innerHTML = `
                        <p>已用: ${usedGB} GB / ${totalGB} GB</p>
                        <p>文件数: ${info.file_count}</p>
                        <p>文件夹数: ${info.folder_count}</p>
                    `;
                }
            } catch (error) {
                console.error('加载存储信息失败:', error);
            }
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        function closeUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.remove('show');
        }

        // 点击外部关闭用户菜单
        document.addEventListener('click', function(e) {
            const userMenu = document.querySelector('.user-menu');
            const dropdown = document.getElementById('userDropdown');
            if (!userMenu.contains(e.target) && !dropdown.contains(e.target)) {
                closeUserMenu();
            }
        });

        // 显示用户信息
        async function showUserInfo() {
            closeUserMenu();

            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            try {
                const response = await fetch('/auth/me', {
                    headers: {'Authorization': `Bearer ${authToken}`}
                });

                if (response.ok) {
                    const user = await response.json();
                    showModal('用户信息', `
                        <div class="user-info-container">
                            <div class="user-info-avatar">
                                <div class="user-info-avatar-circle">${user.username.charAt(0).toUpperCase()}</div>
                            </div>
                            <div class="user-info-details">
                                <div class="user-info-row">
                                    <span class="user-info-label">用户名</span>
                                    <span class="user-info-value">${user.username}</span>
                                </div>
                                <div class="user-info-row">
                                    <span class="user-info-label">邮箱</span>
                                    <span class="user-info-value">${user.email || '未设置'}</span>
                                </div>
                                <div class="user-info-row">
                                    <span class="user-info-label">角色</span>
                                    <span class="user-info-value">${user.is_admin ? '管理员' : '普通用户'}</span>
                                </div>
                                <div class="user-info-row">
                                    <span class="user-info-label">注册时间</span>
                                    <span class="user-info-value">${user.created_at ? new Date(user.created_at).toLocaleDateString() : '未知'}</span>
                                </div>
                            </div>
                        </div>
                    `, null, true); // 只显示确定按钮
                } else {
                    showToast('获取用户信息失败', 'error');
                }
            } catch (error) {
                showToast('获取用户信息失败: ' + error.message, 'error');
            }
        }

        // 修改密码
        async function showChangePassword() {
            closeUserMenu();

            if (!authToken) {
                showToast('请先登录', 'error');
                return;
            }

            showModal('修改密码', `
                <div class="change-password-container">
                    <div class="input-group">
                        <label>原密码</label>
                        <input type="password" id="oldPassword" class="modal-input" placeholder="请输入原密码">
                    </div>
                    <div class="input-group">
                        <label>新密码</label>
                        <input type="password" id="newPassword" class="modal-input" placeholder="请输入新密码（至少6位）">
                    </div>
                    <div class="input-group">
                        <label>确认新密码</label>
                        <input type="password" id="confirmPassword" class="modal-input" placeholder="请再次输入新密码">
                    </div>
                </div>
            `, async () => {
                const oldPassword = document.getElementById('oldPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!oldPassword || !newPassword || !confirmPassword) {
                    showToast('请填写所有字段', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    showToast('新密码长度至少为6位', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showToast('两次输入的新密码不一致', 'error');
                    return;
                }

                try {
                    const response = await fetch('/auth/change-password', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            old_password: oldPassword,
                            new_password: newPassword
                        })
                    });

                    if (response.ok) {
                        showToast('密码修改成功，请重新登录', 'success');
                        closeModal();
                        logout();
                    } else {
                        const error = await response.json();
                        showToast('修改密码失败: ' + error.detail, 'error');
                    }
                } catch (error) {
                    showToast('修改密码失败: ' + error.message, 'error');
                }
            });
        }

        // ============================================
        // 键盘事件
        // ============================================
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // ESC 关闭对话框
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
                hideContextMenu();
            }
        });
    </script>
</body>
</html>
